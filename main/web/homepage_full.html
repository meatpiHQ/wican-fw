<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>WiCAN</title>
    <style>
        :root {
            --primary-color: #24478f;
            --primary-light: #c2d1f0;
            --primary-dark: #1a3266;
            --success-color: #059669;
            --danger-color: #dc2626;
            --background-color: #f0f2f5;
            --white: #ffffff;
            --gray-100: #f7f7f7;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            background-color: var(--background-color);
            margin: 0;
            overflow-x: hidden;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .sidebar {
            height: 100vh;
            width: 240px;
            background-color: var(--white);
            border-right: 1px solid var(--gray-200);
            padding-top: 1rem;
            position: fixed;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        .sidebar button {
            background-color: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 1rem 1.5rem;
            text-align: left;
            width: 100%;
            transition: var(--transition);
            font-size: 0.95rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar button:hover {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .sidebar button.active {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
        }

        .logo {
            width: 80%;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            display: block;
            margin: 2.5rem auto 0;
            padding: 0;
            margin-bottom: 0; /* or reduce the value */
            padding-bottom: 0; /* or reduce the value */
        }

        .content {
            margin-left: 240px;
            padding: 2rem;
            width: calc(100% - 240px);
            max-width: 1200px;
        }

        .tabcontent {
            display: none;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: var(--white);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
        }

        .automate-subtabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .automate-subtablinks {
            border: 1px solid var(--gray-200);
            background-color: var(--white);
            color: var(--gray-700);
            padding: 0.7rem 1.1rem;
            min-height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }

        .automate-subtablinks:hover {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .automate-subtablinks.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white);
        }

        .automate-subtabcontent {
            display: none;
        }

        .description-text {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
            font-weight: 600;
        }

        .form-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        .form-table td:first-child {
            width: 40%;
            font-weight: 500;
            color: var(--gray-700);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
        }

        input[type="text"],
        input[type="file"],
        input[type="number"] {
            width: calc(100% - 1.3rem - 2px);
        }

        input,
        select {
            width: 100%;
            padding: 0.65rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--white);
        }

        input:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(36, 71, 143, 0.1);
            outline: none;
        }

        input:disabled,
        input[type="number"]:disabled,
        select:disabled {
            background-color: var(--gray-100);
            cursor: not-allowed;
        }

        button,
        input[type="button"],
        .store {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            width: auto;
        }

        button:hover,
        input[type="button"]:hover,
        .store:hover {
            background-color: var(--primary-dark);
        }

        button:disabled,
        input[type="button"]:disabled,
        .store:disabled {
            background-color: var(--gray-400);
            cursor: not-allowed;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .section-title-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 1rem;
            margin: 0 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .section-title--no-underline {
            margin: 0;
            padding-bottom: 0;
            border-bottom: 0;
        }

        .section-title-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        #automate .success-button {
            background-color: var(--success-color);
            filter: none;
        }

        #automate .success-button:hover {
            background-color: var(--success-color);
            filter: brightness(0.92);
        }

        #automate .delete-btn {
            background-color: var(--danger-color);
            filter: none;
        }

        #automate .delete-btn:hover {
            background-color: var(--danger-color);
            filter: brightness(0.92);
        }

        .divider {
            margin: 1.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        #table2 {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1rem 0;
        }

        #table2 th,
        #table2 td {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
        }

        #table2 th {
            background-color: var(--gray-100);
            font-weight: 600;
            text-align: left;
        }

        #table2 tr:nth-child(even) {
            background-color: var(--gray-50);
        }


        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-connected {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background-color: #fee2e2;
            color: #991b1b;
        }

        input[type="file"] {
            padding: 0.5rem;
            border: 1px dashed var(--gray-400);
            border-radius: 6px;
            background-color: var(--gray-50);
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: var(--primary-color);
        }

        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .notification-container {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            z-index: 1000;
            padding: 1rem;
            font-weight: 500;
            display: none;
            transition: all 0.3s ease;
        }

        .notification-container.show {
            display: block;
        }
        .form-input::placeholder {
            font-size: 14px; /* Adjust the size as needed */
            color: #888; /* Optional: Customize the color */
        }
/*********************************/
/* Add only these new styles */
.custom-init-group {
    margin-bottom: 1.5rem;
}

.custom-init-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--gray-700);
}

.pid-entry {
    border: none;
    border-radius: 8px;
    padding: 0rem;
    margin-bottom: 0.2rem;
    background: var(--white);
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--gray-600);
}

.pid-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.pid-title {
    color: var(--gray-700);
}

.pid-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.pid-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.pid-field label {
    color: var(--gray-700);
}

.pid-field input,
.pid-field select {
    width: 50%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
}

.button-group {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
}
/*********************************/

        @media (max-width: 768px) {
            .notification-container {
                left: 0;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
        }
        .system-button {
            min-width: 110px;
            width: auto;
            padding: 0.65rem 1.25rem;
            white-space: nowrap;
            margin: 0.1rem;
        }

        .ota-progress {
            width: 100%;
            height: 14px;
            background-color: var(--gray-200);
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            overflow: hidden;
        }

        .ota-progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            transition: width 0.2s ease;
        }

        .ota-progress-fill.is-success {
            background-color: #059669;
        }

        .ota-progress-fill.is-error {
            background-color: #dc2626;
        }

        .ota-progress-text {
            margin-top: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .compact-form-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .compact-form-table td {
            padding: 3px;
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .compact-form-table td:first-child {
            width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compact-form-table input,
        .compact-form-table select {
            width: 100%;
            box-sizing: border-box;
            padding: 2px 5px;
            height: 24px;
            font-size: 0.85rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .system-button {
                min-width: 110px;
                width: 100%;
                margin: 0.1rem 0;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }
            
            .form-table td {
                display: block;
                width: 100%;
            }
            
            .form-table td:first-child {
                padding-bottom: 0.25rem;
            }
            .compact-form-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: auto;
            }

            .compact-form-table td:first-child {
                width: auto;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
            }

            .compact-form-table td {
                padding: 3px;
                vertical-align: middle;
                font-size: 0.85rem;
            }

            .compact-form-table input,
            .compact-form-table select {
                width: 100%;
                box-sizing: border-box;
                padding: 2px 5px;
                height: 24px;
                font-size: 0.85rem;
                border: 1px solid var(--gray-300);
                border-radius: 4px;
            }
        }


        #wifi_networks_list option {
            padding: 0.25rem;
        }

        .wifi-scan-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .wifi-scan-container input {
            flex: 1;
        }

        #wifi_scan_button {
            min-width: 60px;
            white-space: nowrap;
        }

    </style>
</head>

<body onload="Load();">
    <div class="sidebar">
        <embed src="/logo.svg" class="logo" />
        <button class="tablinks" onclick="openTab(event, 'status_view')" id="defaultOpen">
            <span data-lucide="signal" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Status</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'wifi_settings')">
            <span data-lucide="settings" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Settings</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'automate')">
            <span data-lucide="zap" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Automate</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'power_saving_tab')">
            <span data-lucide="battery" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Power Saving</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'logger')">
            <span data-lucide="file-text" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Logger Settings</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'dashboard_tab')">
            <span data-lucide="bar-chart-3" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Dashboard</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'monitor')">
            <span data-lucide="monitor" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>CAN Monitor</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'advanced_tab')">
            <span data-lucide="settings" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Advanced</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'system_tab')">
            <span data-lucide="cpu" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>System</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'vpn_tab')">
            <span data-lucide="shield" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>VPN</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'about_tab')">
            <span data-lucide="info" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>About</b>
        </button>
        <div id="firmware-update-notice" style="margin: 2rem 1rem 1rem 1rem; padding: 0.75rem; border-radius: 8px; background: hsl(0, 89%, 81%); color: #24478f; font-size: 0.95rem; display: none; text-align: center; border: 1px solid #fde68a;">
            <span style="font-weight: 600;">New firmware available!</span><br>
            <a id="firmware-update-link" href="https://github.com/meatpiHQ/wican-fw/releases" target="_blank" style="color: #2563eb; text-decoration: underline;">Download</a>
        </div>
    </div>

    <div class="content">
        <div id="notification" class="notification-container"></div>
        <div id="dashboard_tab" class="tabcontent">
            <div class="section-title">Dashboard</div>
            <div id="dashboard-content">
                <p>Loading dashboard content...</p>
            </div>
        </div>
        <div id="sleep_warning_div" style="display: none;">
            <div class="divider"></div>
            <div class="section-title" style="color: #dc2626;">⚠️ Sleep Mode Disabled Warning</div>
            <table class="form-table">
                <tr>
                    <td colspan="2" style="background-color: #fee2e2; padding: 1rem; border-radius: 6px;">
                        <strong>WARNING:</strong> Disabling sleep mode will continuously drain your vehicle's battery and may cause battery discharge when the vehicle is off. This should only be disabled for testing purposes.
                    </td>
                </tr>
                <tr>
                    <td><label for="sleep_disable_agree"><b>I understand the risks:</b></label></td>
                    <td>
                        <select name="sleep_disable_agree" id="sleep_disable_agree" onChange="submit_enable();">
                            <option value="no">No - I do not agree</option>
                            <option value="yes">Yes - I understand and agree</option>
                        </select>
                    </td>
                </tr>
            </table>
        </div>
        <div id="status_view" class="tabcontent">
            <div class="section-title">Status</div>
            <table class="form-table">
                <tr>
                    <td>WiFi Mode:</td>
                    <td>
                        <div id="wifi_mode_current">AP&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>AP Channel:</td>
                    <td>
                        <div id="ap_channel_status">6&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>WiFi Station:</td>
                    <td>
                        <div id="sta_status">Not Connected&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Station IP:</td>
                    <td>
                        <div id="sta_ip">192.168.3.1&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>DNS Main:</td>
                    <td>
                        <div id="dns_main_status">N/A&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>DNS Backup:</td>
                    <td>
                        <div id="dns_backup_status">N/A&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Time Synced:</td>
                    <td>
                        <div id="time_synced_status">No&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>mDNS:</td>
                    <td>
                        <div id="mdns">&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>CAN Bitrate:</td>
                    <td>
                        <div id="can_bitrate_status">500K&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>CAN Mode:</td>
                    <td>
                        <div id="can_mode_status">Silent&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Port Type:</td>
                    <td>
                        <div id="port_type_status">TCP&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>TCP/UDP Port:</td>
                    <td>
                        <div id="port_status">3333&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Battery Voltage:</td>
                    <td>
                        <div id="batt_voltage">12.8V&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>VPN Status:</td>
                    <td>
                        <div id="vpn_status">Disconnected&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>OBD Chip Status:</td>
                    <td>
                        <div id="obd_chip_status">N/A&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Uptime:</td>
                    <td>
                        <div id="uptime">N/A&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td><input id="check_status_button" name="check_status_button" type="button" onclick="checkStatus()"
                            value="Check status" /></td>
                    <td>&nbsp;</td>
                </tr>
            </table>
        </div>

        <div id="wifi_settings" class="tabcontent">
            <form id="configForm" name="configForm" action="/action_page" onchange="submit_enable();">
                <div class="section-title">AP Config</div>
                <table class="form-table">
                    <tr>
                        <td>Mode:</td>
                        <td>
                            <select name="wifi_mode" id="wifi_mode" onchange="toggleSmartConnectConfig(); submit_enable();">
                                <option value="AP">AP Mode</option>
                                <option value="APStation">AP+Station</option>
                                <option value="BLEStation">BLE+Station</option>
                                <option value="Station">Station Mode</option>
                                <!-- <option value="SmartConnect">SmartConnect</option> -->
                            </select>
                        </td>
                    </tr>
                    <tr style="height: 8px;">
                        <td style="padding-top:0px; padding-bottom:0px;"></td>
                        <td style="padding-top:0px; padding-bottom:0px;">
                            <div id="sta_ble_info" style="display:none;color:#6b7280; font-size: 12px; margin-top: 0px;">Device AP will be disabled. Press and hold the button for 5 seconds to re-enable.</div>
                        </td>
                    </tr>
                    <tr>
                        <td>AP Channel:</td>
                        <td>
                            <select name="ap_ch_value" id="ap_ch_value">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>AP Password:</td>
                        <td>
                            <input type="text" id="ap_pass_value" name="ap_pass_value" value="Testpass" />
                        </td>
                    </tr>
                    <tr>
                        <td>Auto-Disable AP:</td>
                        <td>
                            <select name="ap_auto_disable" id="ap_auto_disable" onchange="submit_enable();">
                                <option value="enable">Enable</option>
                                <option value="disable">Disable</option>
                            </select>
                        </td>
                    </tr>
                    <div id="apconfig_warning_div" style="display: none; margin: 8px 0;">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                <span data-lucide="alert-triangle" style="font-size: 16px; margin-right: 8px;"></span>
                                <strong style="color: #92400e; font-size: 14px;">Warning: IP subnet conflict detected, recommended to Enable Auto-Disable AP</strong>
                            </div>
                        </div>
                    </div>
                </table>

                <!-- SmartConnect Configuration -->
                <div id="smartconnect_config" style="display: none;">
                    <div class="divider"></div>
                    <div class="section-title">SmartConnect Configuration</div>
                    
                    <!-- Home Mode Configuration -->
                    <div class="divider"></div>
                    <div class="section-title" style="font-size: 1.25rem; color: #2563eb; border-bottom: 2px solid #93c5fd; padding-bottom: 0.25rem; display: flex; align-items: center; gap: 8px;">
                        <span data-lucide="home" style="width: 20px; height: 20px;"></span>
                        Home Mode
                    </div>
                    <table class="form-table">
                        <tr>
                            <td>Home SSID:</td>
                            <td>
                                <input type="text" id="home_ssid" name="home_ssid" value="MeatPi" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr>
                            <td>Home Password:</td>
                            <td>
                                <input type="text" id="home_password" name="home_password" value="TomatoSauce" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr>
                            <td>Home Security:</td>
                            <td>
                                <select id="home_security" name="home_security" onchange="submit_enable();">
                                    <option value="wpa3">WPA3</option>
                                    <option value="wpa2">WPA2</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Home Protocol:</td>
                            <td>
                                <select id="home_protocol" name="home_protocol" onchange="submit_enable();">
                                    <option value="elm327">elm327</option>
                                    <option value="auto_pid">AutoPID</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Drive Mode Configuration -->
                    <div class="divider"></div>
                    <div class="section-title" style="font-size: 1.25rem; color: #059669; border-bottom: 2px solid #6ee7b7; padding-bottom: 0.25rem; display: flex; align-items: center; gap: 8px;">
                        <span data-lucide="car" style="width: 20px; height: 20px;"></span>
                        Drive Mode
                    </div>
                    <table class="form-table">
                        <tr>
                            <td>Drive Connection Type:</td>
                            <td>
                                <select name="drive_connection_type" id="drive_connection_type" onchange="toggleDriveConfig(); submit_enable();">
                                    <option value="wifi">WiFi</option>
                                    <option value="ble">BLE</option>
                                </select>
                            </td>
                        </tr>
                        <tr id="drive_wifi_config">
                            <td>Drive SSID:</td>
                            <td>
                                <input type="text" id="drive_ssid" name="drive_ssid" value="MeatPi" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr id="drive_wifi_password">
                            <td>Drive Password:</td>
                            <td>
                                <input type="text" id="drive_password" name="drive_password" value="TomatoSauce" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr id="drive_wifi_security">
                            <td>Drive Security:</td>
                            <td>
                                <select id="drive_security" name="drive_security" onchange="submit_enable();">
                                    <option value="wpa3">WPA3</option>
                                    <option value="wpa2">WPA2</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Drive Protocol:</td>
                            <td>
                                <select id="drive_protocol" name="drive_protocol" onchange="submit_enable();">
                                    <option value="elm327">elm327</option>
                                    <option value="auto_pid">AutoPID</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Drive Mode Timeout:</td>
                            <td class="slider-container">
                                <input type="range" 
                                       id="drive_mode_timeout" 
                                       name="drive_mode_timeout" 
                                       value="60" 
                                       min="10" 
                                       max="600" 
                                       step="1"
                                       oninput="document.getElementById('drive_mode_timeout_value').textContent = this.value;submit_enable();">
                                <span id="drive_mode_timeout_value">60</span>sec
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="divider"></div>

                <!-- Network Configuration Section -->
                <div id="station_config_section">
                    <div class="section-title">Network Configuration</div>
                    <table class="form-table">
                        <tr>
                            <td>SSID:</td>
                            <td>
                                <div class="wifi-scan-container">
                                    <input type="text" id="ssid_value" name="ssid_value" value="MeatPi" disabled />
                                    <button type="button" id="wifi_scan_button" onclick="scanWifiNetworks()" disabled>Scan</button>
                                </div>
                            </td>
                        </tr>
                        <tr id="wifi_networks_row" style="display: none;">
                            <td>Available Networks:</td>
                            <td>
                                <select id="wifi_networks_list" onchange="selectWifiNetwork()">
                                    <option value="">Select a network...</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Password:</td>
                            <td>
                                <input type="text" id="pass_value" name="pass_value" value="TomatoSauce" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td>Security:</td>
                            <td>
                                <select id="sta_security" name="sta_security" disabled>
                                    <option value="wpa3">WPA3</option>
                                    <option value="wpa2">WPA2</option>
                                </select>
                            </td>
                        </tr>
                    </table>

                    <div class="divider"></div>
                    <div class="section-title">Backup Networks <span style="font-weight: normal; font-size: 0.9rem; color: #6b7280;">(max 5)</span></div>
                    <div id="fallback_networks_container">
                        <div id="fallback_rows"></div>
                        <div class="button-group">
                            <button type="button" id="add_fallback_button" onclick="addFallbackNetworkRow()">Add SSID</button>
                        </div>
                        <div style="color:#6b7280; font-size: 12px; margin-top: 6px;">These SSIDs are used as backup networks if the primary station fails.</div>
                    </div>
                </div>
                
                <div class="divider"></div>

                <div class="section-title">BLE</div>
                <table class="form-table">
                    <tr>
                        <td>Passkey:</td>
                        <td>
                            <input type="number" id="ble_pass_value" name="ble_pass_value" value="000000" min="0" max="999999" />
                        </td>
                    </tr>
                    <tr>
                        <td>BLE Status:</td>
                        <td>
                            <select name="ble_status" id="ble_status" onchange="submit_enable();">
                                <option value="enable">Enable</option>
                                <option value="disable" selected>Disable</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>BLE Power:</td>
                        <td class="slider-container">
                            <input type="range"
                                   id="ble_power"
                                   name="ble_power"
                                   value="9"
                                   min="-12"
                                   max="9"
                                   step="3"
                                   oninput="document.getElementById('ble_power_value').textContent = this.value;submit_enable();">
                            <span id="ble_power_value">9</span>dBm
                        </td>
                    </tr>
                </table>

                <div id="ble_warning_div" style="display: none; margin: 8px 0;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <span data-lucide="alert-triangle" style="font-size: 16px; margin-right: 8px;"></span>
                            <strong style="color: #92400e; font-size: 14px;">BLE Connection Warning</strong>
                        </div>
                        <div style="color: #78350f; font-size: 13px; line-height: 1.4;">
                            When BLE connects, WiFi AP is disabled. To restore WiFi AP: disconnect BLE and power cycle device.
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="section-title">CAN</div>
                <table class="form-table">
                    <tr>
                        <td>CAN Bitrate:</td>
                        <td>
                            <select name="can_datarate" id="can_datarate">
                                <option value="5K">5K</option>
                                <option value="10K">10K</option>
                                <option value="20K">20K</option>
                                <option value="25K">25K</option>
                                <option value="50K">50K</option>
                                <option value="100K">100K</option>
                                <option value="125K">125K</option>
                                <option value="250K">250K</option>
                                <option value="500K">500K</option>
                                <option value="800K">800K</option>
                                <option value="1000K">1000K</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>CAN Mode:</td>
                        <td>
                            <select name="can_mode" id="can_mode">
                                <option value="normal" selected="selected">Normal</option>
                                <option value="silent">Silent</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Port Type:</td>
                        <td>
                            <select name="port_type" id="port_type">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>TCP/UDP Port:</td>
                        <td>
                            <input type="number" id="tcp_port_value" name="tcp_port_value" value="3333" min="1" max="65535" />
                        </td>
                    </tr>
                    <tr>
                        <td>Protocol:</td>
                        <td>
                            <select name="protocol" id="protocol">
                                <option value="realdash66">realdash66</option>
                                <option value="slcan">slcan</option>
                                <option value="savvycan">savvyCAN</option>
                                <option value="elm327">elm327</option>
                                <option value="auto_pid">AutoPID</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>MQTT:</td>
                        <td>
                            <select name="mqtt_en" id="mqtt_en">
                                <option value="enable">Enable</option>
                                <option value="disable" selected>Disable</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <div id="mqtt_warning_div" style="display: none; margin: 8px 0;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <span data-lucide="alert-triangle" style="font-size: 16px; margin-right: 8px;"></span>
                            <strong style="color: #92400e; font-size: 14px;">MQTT Connection Warning</strong>
                        </div>
                        <div style="color: #78350f; font-size: 13px; line-height: 1.4;">
                            Do NOT connect to public MQTT brokers. Only use a private/local broker or a trusted cloud service.
                        </div>
                    </div>
                </div>

                <div id="mqtt_en_div">
                    <div class="divider"></div>
                    <div class="section-title">MQTT</div>
                    <table class="form-table">
                        <tr>
                            <td><label for="mqtt_url"><b>MQTT URL:</b></label></td>
                            <td><input type="text" id="mqtt_url" name="mqtt_url" value="127.0.0.1" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_port"><b>MQTT Port:</b></label></td>
                            <td><input type="number" id="mqtt_port" name="mqtt_port" style="width: 180px;" value="1883" min="1" max="65535" />
                            </td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_security"><b>Security:</b></label></td>
                            <td>
                                <select id="mqtt_security" name="mqtt_security" style="width: 180px;" onchange="toggleMqttTLS();submit_enable();">
                                    <option value="none" selected>None (MQTT)</option>
                                    <option value="tls">TLS (MQTTS)</option>
                                </select>
                            </td>
                        </tr>
                        <tr id="mqtt_cert_set_row" style="display:none;">
                            <td><label for="mqtt_cert_set"><b>Cert Set:</b></label></td>
                            <td>
                                <select id="mqtt_cert_set" name="mqtt_cert_set" style="width: 180px;" onchange="submit_enable();">
                                    <option value="default">default</option>
                                </select>
                                <div style="font-size:0.75rem; color:#6b7280; margin-top:4px;">Manage sets under System → Certificate Manager.</div>
                            </td>
                        </tr>
                        <tr id="mqtt_skip_cn_row" style="display:none;">
                            <td><label for="mqtt_skip_cn"><b>Skip CN check:</b></label></td>
                            <td>
                                <select id="mqtt_skip_cn" name="mqtt_skip_cn" style="width: 180px;" onchange="submit_enable();">
                                    <option value="disable" selected>Disable</option>
                                    <option value="enable">Enable</option>
                                </select>
                                <div style="font-size:0.75rem; color:#6b7280; margin-top:4px;">When enabled, TLS server certificate common-name/hostname mismatch is ignored.</div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_user"><b>MQTT User:</b></label></td>
                            <td><input type="text" id="mqtt_user" name="mqtt_user" value="meatpi" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_pass"><b>MQTT Pass:</b></label></td>
                            <td><input type="text" id="mqtt_pass" name="mqtt_pass" value="meatpi" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_tx_topic"><b>TX Topic:</b></label></td>
                            <td><input type="text" id="mqtt_tx_topic" name="mqtt_tx_topic" value="" /></td>
                            <td><input type="checkbox" id="mqtt_tx_en_checkbox" name="mqtt_tx_en_checkbox"
                                    onchange="txCheckBoxChanged()"></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_rx_topic"><b>RX Topic:</b></label></td>
                            <td><input type="text" id="mqtt_rx_topic" name="mqtt_rx_topic" value="" /></td>
                            <td><input type="checkbox" id="mqtt_rx_en_checkbox" name="mqtt_rx_en_checkbox" 
                                    onchange="rxCheckBoxChanged()"></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_status_topic"><b>Status Topic:</b></label></td>
                            <td><input type="text" id="mqtt_status_topic" name="mqtt_status_topic" value="" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_elm327_log"><b>MQTT elm327 log:</b></label></td>
                            <td><select name="mqtt_elm327_log" style="width: 93px;" id="mqtt_elm327_log"
                                    onchange="alert_elm327()">
                                    <option value="enable">Enable</option>
                                    <option value="disable">Disable</option>
                                </select></td>
                        </tr>
                        <tr>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                    </table>
                    <div style="overflow-x:auto;">
                        <div class="section-title">MQTT CAN Filter</div>
                        <table id="can_flt_table" >
                            <tr>
                                <th style="text-align: left;">CAN ID (dec)</th>
                                <th style="text-align: left;">Name</th>
                                <th style="text-align: left;">PID</th>
                                <th style="text-align: left;">Index</th>
                                <th style="text-align: left;">Start Bit</th>
                                <th style="text-align: left;">Bit Length</th>
                                <th style="text-align: left;">Expression</th>
                                <th style="text-align: left;">Cycle ms</th>
                                <th><input id="store_canflt_button" name="store_canflt_button" type="button"
                                        onclick="storeCANFLT()" value="Store" style="width: 100%;" /></th>
                            </tr>
                            <tr>
                                <td style="width: 10%;" ><input type="number" id="canId" min="0" max="536870912" style="width: 80%;"/></td>
                                <td style="width: 20%;"><input type="text" id="name" maxlength="16" style="width: 90%;"/></td>
                                <td style="width: 10%;"><input type="number" id="pid"  style="width: 80%;"/></td>
                                <td style="width: 10%;"><input type="number" id="pindex"  style="width: 80%;"/></td>
                                <td style="width: 10%;"><input type="number" id="startBit" min="0" max="63"  style="width: 80%;"/></td>
                                <td style="width: 10%;"><input type="number" id="bitLength" min="1" max="64" style="width: 80%;"/></td>
                                <td style="width: 20%;"><input type="text" id="expression" maxlength="64"  style="width: 90%;"/></td>
                                <td style="width: 10%;"><input type="number" id="cycle" min="100" max="1000"  style="width: 80%;"/></td>
                                <td><input id="add_row_button" name="add_row_button" type="button" onclick="addCANFLTRow()"
                                        value="Add ID" style="width: 100%;" /></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </form>
        </div>

        <div id="automate" class="tabcontent">
            <div class="section-title">Automate</div>
            <table class="form-table">
                <tr>
                    <td>Data Grouping:</td>
                    <td>
                        <select id="grouping" name="grouping" onchange="toggleSendToFields(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                            <option value="enable">Enable</option>
                        </select>
                    </td>
                </tr>
            </table>
            
            <div class="section-title" style="margin-top:1rem;">Home Assistant</div>
            <table class="form-table">
                <tr>
                    <td>WebHook:</td>
                    <td>
                        <select id="webhook_en" name="webhook_en" onchange="submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>WebHook URL:</td>
                    <td>
                        <input type="text" id="webhook_url" name="webhook_url" readonly style="background-color:#f5f5f5; cursor:not-allowed;">
                    </td>
                </tr>
                <tr>
                    <td>WebHook Interval (s):</td>
                    <td>
                        <input type="text" id="webhook_interval" name="webhook_interval" readonly style="background-color:#f5f5f5; cursor:not-allowed;">
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="font-size:0.7rem; color:#555; margin-top:0.5rem;">WebHook configuration is set in the Home Assistant integration.</td>
                </tr>
                <tr>
                    <td>WebHook Data Mode:</td>
                    <td>
                        <select id="webhook_data_mode" name="webhook_data_mode" onchange="enableAutoStoreButton();submit_enable();">
                            <option value="full">Full Data (All Fields)</option>
                            <option value="changed">Changed Values Only</option>
                        </select>
                    </td>
                </tr>
                <tr style="display:none;">
                    <td>MQTT HA Discovery:</td>
                    <td>
                        <select id="ha_discovery" name="ha_discovery" onchange="toggleSendToFields(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding:4px 0; font-size:0.8rem; color:#555;">Configure one or more destinations below (max 6). Legacy single destination fields are derived from the first entry.</td>
                </tr>
            </table>
            <div id="autopid_warning_div" style="display: none; margin: 8px 0;">
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <span data-lucide="alert-triangle" style="font-size: 16px; margin-right: 8px;"></span>
                        <strong style="color: #92400e; font-size: 14px;">AutoPID Warning</strong>
                    </div>
                    <div style="color: #78350f; font-size: 13px; line-height: 1.4;">
                        AutoPID is not Enabled, you must go to Settings → CAN → Protocol , select AutoPID and press Submit changes to use this feature.
                    </div>
                </div>
            </div>
            <div class="section-title" style="margin-top:1rem;">User Destinations</div>
            <div id="destinations_section" style="background:#ffffff; border:1px solid #e2e8f0; border-radius:6px; padding:0.75rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <div style="font-weight:600;">Configured Destinations</div>
                    <button id="add_destination_btn" class="primary-button success-button" style="padding:4px 10px;" onclick="addDestinationEntry();submit_enable();">Add Destination</button>
                </div>
                <div id="destinations_container"></div>
                <div style="font-size:0.7rem; color:#555; margin-top:0.5rem;">Cycle &ge; 1000 ms (or 0 for event). HTTPS requires a cert set (or 'default' embedded CA). ABRP_API requires a token. To add more certs go to System tab.</div>
            </div>
            <div class="section-title" style="margin-top:1rem;">Automate Parameters</div>
            <div class="automate-subtabs">
                <button class="automate-subtablinks" id="automateSubDefaultOpen" onclick="openAutomateSubTab(event, 'automate_std')">Standard PIDs</button>
                <button class="automate-subtablinks" onclick="openAutomateSubTab(event, 'automate_vehicle')">Vehicle Specific</button>
                <button class="automate-subtablinks" onclick="openAutomateSubTab(event, 'automate_custom')">User Custom</button>
            </div>
            <div id="automate_std" class="automate-subtabcontent">
                <div class="section-title">Standard PIDs</div>
                <table class="form-table">
                    <tr>
                        <td>Standard PIDs:</td>
                        <td>
                            <select id="standard_pids" name="standard_pids" onchange="toggleStandardPIDOptions();enableAutoStoreButton();submit_enable();">
                                <option value="disable">Disable</option>
                                <option value="enable">Enable</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>ECU Protocol:</td>
                        <td>
                            <select id="ecu_protocol" name="ecu_protocol" onchange="enableAutoStoreButton();submit_enable();">
                                <option value="0">0- Automatic</option>
                                <option value="6">6- ISO 15765-4 (CAN 11bit/500K)</option>
                                <option value="7">7- ISO 15765-4 (CAN 29bit/500K)</option>
                                <option value="8">8- ISO 15765-4 (CAN 11bit/250K)</option>
                                <option value="9">9- ISO 15765-4 (CAN 29bit/250K)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Available PIDs:</td>
                        <td style="display: flex; align-items: center; gap: 5px;">
                            <select id="available_pids" name="available_pids" disabled 
                                    onchange="enableAutoStoreButton();submit_enable();" style="flex: 1;">
                            </select>
                            <button id="add_pid_button" onclick="addSelectedPID()" disabled style="margin-left: 5px;">Add PID</button>
                            <button id="scan_pids_button" onclick="scanAvailablePIDs()" class="success-button" style="margin-left: 5px;">Scan PIDs</button>
                        </td>
                    </tr>
                    
                </table>
                <div id="standard_pids_table">
                    <div class="std-pid-entries"></div>
                </div>
            </div>

            <div id="automate_vehicle" class="automate-subtabcontent">
                <div class="section-title">Vehicle Specific PIDs</div>
                <table class="form-table">
                    <tr>
                        <td>Vehicle Specific PIDs:</td>
                        <td>
                            <select id="car_specific" name="car_specific" onchange="toggleCarModel(); enableAutoStoreButton();submit_enable();">
                                <option value="disable">Disable</option>
                                <option value="enable">Enable</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Vehicle Model:</td>
                        <td style="display: flex; align-items: center; gap: 5px;">
                            <select id="car_model" name="car_model" onchange="enableAutoStoreButton();submit_enable();" style="flex: 1;"></select>
                            <button onclick="fetchVehicleProfiles()" class="success-button" style="margin-left: 5px;">Get Latest</button>
                        </td>
                    </tr>
                    <tr>
                        <td>Vehicle Profiles:</td>
                        <td>
                            <form id="car_data_form" enctype="multipart/form-data">
                                <input id="car_data_file" name="car_data_file" type="file" onchange="loadLocalCarModels();submit_enable();" />
                            </form>
                        </td>
                    </tr>
                    <tr>
                        <td>Specific Initialisation:</td>
                        <td>
                            <input type="text" id="specific_init" name="specific_init" oninput="enableAutoStoreButton()">
                        </td>
                    </tr>
                </table>

                <div id="specific_pids_table">
                    <div class="specific-pid-entries"></div>
                </div>

                <div class="section-title" style="margin-top:1rem;">Vehicle Specific Filters</div>
                <div id="specific_filters_table">
                    <div class="specific-canfilter-entries"></div>
                </div>
            </div>

            <div id="automate_custom" class="automate-subtabcontent">
                <div class="section-title-row">
                    <div class="section-title section-title--no-underline">Custom PIDs</div>
                    <div class="section-title-actions">
                        <button onclick="addRowAutoTable()" class="primary-button success-button">New PID</button>
                    </div>
                </div>
                <table class="form-table">
                    <tr>
                        <td>Custom Initialisation:</td>
                        <td>
                            <input type="text" id="initialisation" name="initialisation" oninput="enableAutoStoreButton()">
                        </td>
                    </tr>
                </table>

                <div id="automate_table">
                    <div class="pid-entries"></div>
                </div>

                <div class="section-title-row" style="margin-top:1rem;">
                    <div class="section-title section-title--no-underline">Custom Filters</div>
                    <div class="section-title-actions">
                        <button type="button" onclick="addCustomFilterRow();submit_enable();" class="primary-button success-button">New Filter</button>
                    </div>
                </div>
                <div id="custom_filters_table">
                    <div class="custom-canfilter-entries"></div>
                </div>
            </div>
            <div class="section-title" style="margin-top:1rem;"> </div>
            <div class="button-group">
                <button id="custom_pid_store" onclick="storeAutoTableData()" class="store success-button" disabled>Store</button>
            </div>
        </div>

        <div id="monitor" class="tabcontent">
            <div class="section-title">Monitor Settings</div>
            <table class="form-table">
                <tr>
                    <td>Bitrate</td>
                    <td>Filter</td>
                    <td>Mask</td>
                </tr>
                <tr>
                    <td>
                        <select name="mon_datarate" id="mon_datarate">
                            <option value="10K">10K</option>
                            <option value="20K">20K</option>
                            <option value="50K">50K</option>
                            <option value="100K">100K</option>
                            <option value="125K">125K</option>
                            <option value="250K">250K</option>
                            <option value="500K" selected="selected">500K</option>
                            <option value="800K">800K</option>
                            <option value="1000K">1Mbit</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" id="mon_filter" name="mon_filter" value="00000000" />
                    </td>
                    <td>
                        <input type="text" id="mon_mask" name="mon_mask" value="FFFFFFFF" />
                    </td>
                    <td><input id="mon_button" name="mon_button" type="button" onclick="mon_control()" value="Start"
                        style="font-size: 100%;" /></td>
                </tr>
            </table>
            <div class="divider"></div>
            <table id="table2" class="form-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Len</th>
                        <th>Data</th>
                        <th>Time</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="power_saving_tab" class="tabcontent">
            <div class="section-title">Sleep Mode</div>
            <table class="form-table">
                <tr>
                    <td>Sleep Mode:</td>
                    <td>
                        <select name="sleep_status" id="sleep_status" onChange="toggleSleepWarning();submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Sleep Voltage:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="sleep_volt" 
                               name="sleep_volt" 
                               value="13.2" 
                               min="12.0" 
                               max="15.0" 
                               step="0.1"
                               oninput="document.getElementById('sleep_volt_value').textContent = this.value;submit_enable();">
                        <span id="sleep_volt_value">13.2</span>V
                    </td>
                </tr>
                <tr>
                    <td>Sleep After:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="sleep_time" 
                               name="sleep_time" 
                               value="5" 
                               min="1" 
                               max="30" 
                               step="1"
                               oninput="document.getElementById('sleep_time_value').textContent = this.value;submit_enable();">
                        <span id="sleep_time_value">5</span>min
                    </td>
                </tr>
                <tr>
                    <td>Periodic wake up:</td>
                    <td>
                        <select name="periodic_wakeup" id="periodic_wakeup" onchange="submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr id="wakeup_every_row">
                    <td>Wakeup Every:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="wakeup_interval" 
                               name="wakeup_interval" 
                               value="60" 
                               min="5" 
                               max="240" 
                               step="1"
                               oninput="document.getElementById('wakeup_interval_value').textContent = this.value;submit_enable();">
                        <span id="wakeup_interval_value">60</span>min
                    </td>
                </tr>
                <tr>
                    <td>Battery Alert:</td>
                    <td>
                        <select name="batt_alert" id="batt_alert" onchange="submit_enable();">
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
            </table>
            <div id="batt_alert_div">
                <div class="divider"></div>
                <div class="section-title">Battery Alert</div>
                <table class="form-table">
                    <tr>
                        <td><label for="batt_alert_ssid"><b>SSID:</b></label></td>
                        <td><input type="text" id="batt_alert_ssid" name="batt_alert_ssid" value="MeatPi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_pass"><b>Password:</b></label></td>
                        <td><input type="text" id="batt_alert_pass" name="batt_alert_pass" value="TomatoSauce" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_volt"><b>Alert Voltage:</b></label></td>
                        <td><input type="number" step="0.1" id="batt_alert_volt" name="batt_alert_volt" value="11.0"
                                min="9.0" max="15.0" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_protocol"><b>Alert Protocol:</b></label></td>
                        <td><select name="batt_alert_protocol" style="width: 93px;" id="batt_alert_protocol">
                                <option value="mqtt">MQTT</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_url"><b>Alert URL:</b></label></td>
                        <td><input type="text" id="batt_alert_url" name="batt_alert_url" value="127.0.0.1" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_port"><b>Alert Port:</b></label></td>
                        <td><input type="number" id="batt_alert_port" name="batt_alert_port" value="1883" min="1"
                                max="65535" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_mqtt_user"><b>Alert MQTT User:</b></label></td>
                        <td><input type="text" id="batt_mqtt_user" name="batt_mqtt_user" value="meatpi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_mqtt_pass"><b>Alert MQTT Pass:</b></label></td>
                        <td><input type="text" id="batt_mqtt_pass" name="batt_mqtt_pass" value="meatpi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_topic"><b>Alert Topic:</b></label></td>
                        <td><input type="text" id="batt_alert_topic" name="batt_alert_topic" value="CAR1/voltage" />
                        </td>
                    </tr>
                    <tr>
                        <td><b>Alert every:</b></td>
                        <td><select name="batt_alert_time" style="width: 93px;" id="batt_alert_time">
                                <option value="1">1hr</option>
                                <option value="6">6hr</option>
                                <option value="12">12hr</option>
                                <option value="24">1day</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                </table>
            </div>

        </div>
        <div id="logger" class="tabcontent">
            <div class="section-title">Logger Settings</div>
            <table class="form-table">
                <tr>
                    <td>Logger:</td>
                    <td>
                        <select name="logger_status" id="logger_status" onChange="submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Log Storage:</td>
                    <td>
                        <select name="log_storage" id="log_storage" onChange="submit_enable();">
                            <option value="sdcard">SDcard</option>
                            <!-- <option value="internal">Internal</option> -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Storage Filesystem:</td>
                    <td>
                        <select name="log_filesystem" id="log_filesystem" onChange="submit_enable();">
                            <option value="fatfs">FATFS</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Log Period:</td>
                    <td class="slider-container">
                        <input type="range" 
                            id="log_period" 
                            name="log_period" 
                            value="60" 
                            min="10" 
                            max="300" 
                            step="1"
                            oninput="document.getElementById('log_period_value').textContent = this.value;submit_enable();">
                        <span id="log_period_value">60</span>sec
                    </td>
                </tr>
            </table>
        </div>
        <div id="advanced_tab" class="tabcontent">
            <div class="section-title">Advanced Settings</div>
            <table class="form-table">
                <tr>
                    <td>Motion Threshold:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="imu_threshold" 
                               name="imu_threshold" 
                               value="8" 
                               min="1" 
                               max="32" 
                               step="1"
                               oninput="document.getElementById('imu_threshold_value').textContent = (this.value * 3.9).toFixed(1) + ' mg';submit_enable();"
                               onchange="submit_enable();">
                        <span id="imu_threshold_value">31.2 mg</span>
                    </td>
                </tr>
                <tr>
                    <td>ELM327 UDP Log:</td>
                    <td>
                        <select id="elm327_udp_log" name="elm327_udp_log" onchange="toggleElm327UdpLogWarning();submit_enable();">
                            <option value="disable" selected>Disable</option>
                            <option value="enable">Enable</option>
                        </select>
                    </td>
                </tr>
            </table>

            <div id="elm327_udp_log_warning_div" style="display: none; margin: 8px 0;">
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <span data-lucide="alert-triangle" style="font-size: 16px; margin-right: 8px;"></span>
                        <strong style="color: #92400e; font-size: 14px;">ELM327 UDP Log Enabled</strong>
                    </div>
                    <div style="color: #78350f; font-size: 13px; line-height: 1.4;">
                        UDP logging can impact performance. Turn it off when not needed.
                    </div>
                </div>
            </div>
        </div>
        <div id="system_tab" class="tabcontent">
            <div class="section-title">System</div>
            <table class="form-table">
                <tr>
                    <td>Reboot WiCAN:</td>
                    <td><input id="reboot_button" name="reboot_button" type="button" onclick="reboot()" value="Reboot" class="system-button" /></td>
                </tr>
                <tr>
                    <td>Download Configuration:</td>
                    <td><input id="download_cfg_butt" name="download_cfg_butt" type="button" onclick="downloadCfg()" value="Download" class="system-button" /></td>
                </tr>
                <tr>
                    <td>Upload Configuration:</td>
                    <td>
                        <input type="button" onclick="document.getElementById('fileInput').click()" value="Upload" class="system-button" />
                        <input type="file" id="fileInput" accept=".json" onchange="uploadCfg()" style="display: none;" />
                    </td>
                </tr>
            </table>
        
            <div class="section-title">Firmware Update</div>
            <div class="description-text">
                Firmware updates are available on <a href="https://github.com/meatpiHQ/wican-fw/releases">GitHub</a>. Instructions are available <a href="https://meatpihq.github.io/wican-fw/config/firmware-update">here</a>.
            </div>
            <form id="ota_form" action="/upload/ota.bin" method="post" enctype="multipart/form-data">
                <table class="form-table">
                    <tr>
                        <td><input id="ota_file" name="ota_file" type="file" accept=".bin" /></td>
                        <td><input id="ota_submit_button" type="button" value="Update" onclick="otaClick()" class="system-button" /></td>
                    </tr>
                    <tr id="ota_progress_row" style="display: none;">
                        <td colspan="2">
                            <div class="ota-progress">
                                <div id="ota_progress_fill" class="ota-progress-fill" style="width: 0%;"></div>
                            </div>
                            <div id="ota_progress_text" class="ota-progress-text">0%</div>
                        </td>
                    </tr>
                </table>
            </form>

            <div class="section-title">Certificate Manager</div>
            <div class="description-text">
                Manage up to 10 named certificate sets. Each set may include: CA (for custom trust), and/or client certificate & key for mutual TLS.
                Enter a unique name (immutable), choose files, then Add. Delete removes the set directory.
            </div>
            <div style="margin:0.75rem 0; padding:0.75rem; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:6px;">
                <table style="width:100%;" class="form-table">
                    <tr>
                        <td style="width:140px;">New Cert Name:</td>
                        <td style="display:flex; gap:0.5rem; align-items:center;">
                            <input style="flex:1;" type="text" id="certmgr_name" placeholder="e.g. abrp_prod" maxlength="24" />
                            <input type="button" class="system-button" value="Add Set" onclick="certManagerAddSet();" />
                        </td>
                    </tr>
                    <tr>
                        <td>CA Certificate:</td>
                        <td><input type="file" id="certmgr_ca" accept=".pem,.crt" /></td>
                    </tr>
                    <tr>
                        <td>Client Certificate:</td>
                        <td><input type="file" id="certmgr_client_cert" accept=".pem,.crt" /></td>
                    </tr>
                    <tr>
                        <td>Client Key:</td>
                        <td><input type="file" id="certmgr_client_key" accept=".pem,.key" /></td>
                    </tr>
                </table>
                <div style="font-size:0.75rem; color:#555;">Name: letters, digits, dash, underscore. CA file strongly recommended unless using system trust. Client cert+key optional but must both be provided for mutual TLS.</div>
            </div>
            <div style="margin-top:1rem;">
                <div style="font-weight:600; margin-bottom:0.5rem;">Existing Sets</div>
                <table id="certmgr_table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f8fafc;">
                            <th style="text-align:left; padding:6px; border:1px solid #e2e8f0;">Name</th>
                            <th style="text-align:left; padding:6px; border:1px solid #e2e8f0;">CA</th>
                            <th style="text-align:left; padding:6px; border:1px solid #e2e8f0;">Client Cert</th>
                            <th style="text-align:left; padding:6px; border:1px solid #e2e8f0;">Client Key</th>
                            <th style="text-align:left; padding:6px; border:1px solid #e2e8f0;"></th>
                        </tr>
                    </thead>
                    <tbody id="certmgr_body">
                        <tr><td colspan="5" style="padding:8px; text-align:center; color:#555;">No certificate sets</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="font-size:0.7rem; color:#666; margin-top:0.75rem;">Single-cert uploads appear as the read-only 'default' set.</div>
        </div>

        <div id="vpn_tab" class="tabcontent">
            <div class="section-title" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <span>VPN Settings</span>
                <span id="vpn_status_badge" class="status-indicator status-disconnected" title="VPN status">Disconnected</span>
            </div>
            <table class="form-table">
                <tr>
                    <td>VPN:</td>
                    <td>
                        <select name="vpn_enabled" id="vpn_enabled" onchange="toggleVpnConfig(); submit_enable();">
                            <option value="disable">Disabled</option>
                            <option value="wireguard">WireGuard</option>
                        </select>
                    </td>
                </tr>
            </table>

            <div id="wireguard_config" style="display: none;">
                <div class="divider"></div>
                <div class="section-title">WireGuard Configuration</div>
                
                <div class="section-title" style="font-size: 1.25rem; color: #2563eb; border-bottom: 2px solid #93c5fd; padding-bottom: 0.25rem; display: flex; align-items: center; gap: 8px;">
                    <span data-lucide="settings" style="width: 20px; height: 20px;"></span>
                    Interface
                </div>
                <table class="form-table">
                    <tr>
                        <td>Private Key:</td>
                        <td>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="wg_private_key" name="wg_private_key" placeholder="Loaded from config file" readonly style="flex: 1;" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Public Key:</td>
                        <td>
                            <input type="text" id="wg_public_key" name="wg_public_key" placeholder="Loaded from config file" readonly />
                        </td>
                    </tr>
                    <tr>
                        <td>Address:</td>
                        <td>
                            <input type="text" id="wg_address" name="wg_address" placeholder="e.g., 10.2.2.3/32" oninput="submit_enable();" />
                        </td>
                    </tr>
                </table>

                <div class="section-title" style="font-size: 1.25rem; color: #2563eb; border-bottom: 2px solid #93c5fd; padding-bottom: 0.25rem; display: flex; align-items: center; gap: 8px;">
                    <span data-lucide="users" style="width: 20px; height: 20px;"></span>
                    Peer
                </div>
                <table class="form-table">
                    <tr>
                        <td>Public Key:</td>
                        <td>
                            <input type="text" id="wg_peer_public_key" name="wg_peer_public_key" placeholder="Server's public key" oninput="submit_enable();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Allowed IPs:</td>
                        <td>
                            <input type="text" id="wg_allowed_ips" name="wg_allowed_ips" placeholder="e.g., 0.0.0.0/0" oninput="submit_enable();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Endpoint:</td>
                        <td>
                            <input type="text" id="wg_endpoint" name="wg_endpoint" placeholder="e.g., 111.111.11.11:51820" oninput="submit_enable();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Persistent Keepalive:</td>
                        <td>
                            <input type="number" id="wg_persistent_keepalive" name="wg_persistent_keepalive" placeholder="25" min="0" max="65535" oninput="submit_enable();" />
                        </td>
                    </tr>
                </table>

                <div class="divider"></div>
                <div class="section-title">Configuration File</div>
                <table class="form-table">
                    <tr>
                        <td>Load Config File:</td>
                        <td>
                            <input type="file" id="wg_config_file" accept=".conf" onchange="loadWireGuardConfig()" />
                        </td>
                    </tr>
                    <tr>
                        <td>Test Connection:</td>
                        <td>
                            <button type="button" onclick="testVpnConnection()" id="test_vpn_button">Test Connection</button>
                        </td>
                    </tr>
                </table>

                <div class="divider"></div>
                <div class="section-title">VPN Debug</div>
                <table class="form-table">
                    <tr>
                        <td>Actions:</td>
                        <td style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                            <button type="button" onclick="vpnDebugRefresh()" id="vpn_dbg_refresh_btn">Refresh</button>
                            <button type="button" onclick="vpnDebugResolveEndpoint()" id="vpn_dbg_resolve_ep_btn">Resolve Endpoint</button>
                            <button type="button" onclick="vpnDebugResolveNtp()" id="vpn_dbg_resolve_ntp_btn">Resolve NTP</button>
                        </td>
                    </tr>
                    <tr>
                        <td>Gating:</td>
                        <td><div id="vpn_dbg_gating">-</div></td>
                    </tr>
                    <tr>
                        <td>VPN Status:</td>
                        <td><div id="vpn_dbg_status">-</div></td>
                    </tr>
                    <tr>
                        <td>Station (STA):</td>
                        <td><div id="vpn_dbg_sta">-</div></td>
                    </tr>
                    <tr>
                        <td>DNS Servers:</td>
                        <td><div id="vpn_dbg_dns">-</div></td>
                    </tr>
                    <tr>
                        <td>Endpoint Resolve:</td>
                        <td><div id="vpn_dbg_resolve">-</div></td>
                    </tr>
                    <tr>
                        <td>NTP Resolve:</td>
                        <td><div id="vpn_dbg_ntp_resolve">-</div></td>
                    </tr>
                    <tr>
                        <td>Raw:</td>
                        <td>
                            <pre id="vpn_dbg_raw" style="margin:0; font-weight:normal; white-space:pre-wrap; word-break:break-word; max-height:220px; overflow:auto; background:var(--gray-100); border:1px solid var(--gray-300); border-radius:6px; padding:10px;">-</pre>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
               
        <div id="about_tab" class="tabcontent">
            <div class="section-title">About</div>
            <table class="form-table">
                <tr>
                    <td>Firmware ver:</td>
                    <td>
                        <div id="fw_version">1.00</div>
                    </td>
                </tr>
                <tr>
                    <td>Hardware ver:</td>
                    <td>
                        <div id="hw_version">v2.10</div>
                    </td>
                </tr>
                <tr>
                    <td>Git ver:</td>
                    <td>
                        <div id="git_version">v2.10</div>
                    </td>
                </tr>
                <tr>
                    <td>Designed By:</td>
                    <td>
                        <div id="made_by"><a href="https://www.meatpi.com/"><b>meatpi.com</b></a></div>
                    </td>
                </tr>
            </table>
        </div>
        <input id="submit_button" name="submit_button" type="button" onclick="postConfig()" value="Submit Changes" disabled />
    </div>
    <script src="/main.js"></script>
    <script src="/lucide_icons.js"></script>
</body>

</html>
