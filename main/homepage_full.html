<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>WiCAN</title>
    <style>
        :root {
            --primary-color: #24478f;
            --primary-light: #c2d1f0;
            --primary-dark: #1a3266;
            --background-color: #f0f2f5;
            --white: #ffffff;
            --gray-100: #f7f7f7;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            background-color: var(--background-color);
            margin: 0;
            overflow-x: hidden;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .sidebar {
            height: 100vh;
            width: 240px;
            background-color: var(--white);
            border-right: 1px solid var(--gray-200);
            padding-top: 1rem;
            position: fixed;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        .sidebar button {
            background-color: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 1rem 1.5rem;
            text-align: left;
            width: 100%;
            transition: var(--transition);
            font-size: 0.95rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar button:hover {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .sidebar button.active {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
        }

        .logo {
            width: 80%;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            display: block;
            margin: 2.5rem auto 0;
            padding: 0;
            margin-bottom: 0; /* or reduce the value */
            padding-bottom: 0; /* or reduce the value */
        }

        .content {
            margin-left: 240px;
            padding: 2rem;
            width: calc(100% - 240px);
            max-width: 1200px;
        }

        .tabcontent {
            display: none;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: var(--white);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
        }

        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
            font-weight: 600;
        }

        .form-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        .form-table td:first-child {
            width: 40%;
            font-weight: 500;
            color: var(--gray-700);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.65rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--white);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(36, 71, 143, 0.1);
            outline: none;
        }

        input[type="text"]:disabled,
        input[type="number"]:disabled,
        select:disabled {
            background-color: var(--gray-100);
            cursor: not-allowed;
        }

        button,
        input[type="button"],
        .store {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        button:hover,
        input[type="button"]:hover,
        .store:hover {
            background-color: var(--primary-dark);
        }

        button:disabled,
        input[type="button"]:disabled,
        .store:disabled {
            background-color: var(--gray-400);
            cursor: not-allowed;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .divider {
            margin: 1.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        #table2 {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1rem 0;
        }

        #table2 th,
        #table2 td {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
        }

        #table2 th {
            background-color: var(--gray-100);
            font-weight: 600;
            text-align: left;
        }

        #table2 tr:nth-child(even) {
            background-color: var(--gray-50);
        }


        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-connected {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background-color: #fee2e2;
            color: #991b1b;
        }

        input[type="file"] {
            padding: 0.5rem;
            border: 1px dashed var(--gray-400);
            border-radius: 6px;
            background-color: var(--gray-50);
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: var(--primary-color);
        }

        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .notification-container {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            z-index: 1000;
            padding: 1rem;
            font-weight: 500;
            display: none;
            transition: all 0.3s ease;
        }

        .notification-container.show {
            display: block;
        }
        .form-input::placeholder {
            font-size: 14px; /* Adjust the size as needed */
            color: #888; /* Optional: Customize the color */
        }
/*********************************/
/* Add only these new styles */
.custom-init-group {
    margin-bottom: 1.5rem;
}

.custom-init-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--gray-700);
}

.pid-entry {
    border: none;
    border-radius: 8px;
    padding: 0rem;
    margin-bottom: 0.2rem;
    background: var(--white);
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--gray-600);
}

.pid-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.pid-title {
    color: var(--gray-700);
}

.pid-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.pid-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.pid-field label {
    color: var(--gray-700);
}

.pid-field input,
.pid-field select {
    width: 50%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
}

.button-group {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
}
/*********************************/

        @media (max-width: 768px) {
            .notification-container {
                left: 0;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }
            
            .form-table td {
                display: block;
                width: 100%;
            }
            
            .form-table td:first-child {
                padding-bottom: 0.25rem;
            }
        }
    </style>
</head>

<body onload="Load()">
    <div class="sidebar">
        <embed src="/logo.svg" class="logo" />
        <button class="tablinks" onclick="openTab(event, 'status_view')" id="defaultOpen"><b>Status</b></button>
        <button class="tablinks" onclick="openTab(event, 'wifi_settings')"><b>Settings</b></button>
        <button class="tablinks" onclick="openTab(event, 'automate')"><b>Automate</b></button>
        <button class="tablinks" onclick="openTab(event, 'monitor')"><b>Monitor</b></button>
        <button class="tablinks" onclick="openTab(event, 'power_saving_tab')"><b>Power Saving</b></button>
        <button class="tablinks" onclick="openTab(event, 'about_tab')"><b>About</b></button>
    </div>

    <div class="content">
        <div id="notification" class="notification-container"></div>
        <div id="status_view" class="tabcontent">
            <div class="section-title">Status</div>
            <table class="form-table">
                <tr>
                    <td>WiFi Mode:</td>
                    <td>
                        <div id="wifi_mode_current">AP&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>AP Channel:</td>
                    <td>
                        <div id="ap_channel_status">6&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>WiFi Station:</td>
                    <td>
                        <div id="sta_status">Not Connected&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Station IP:</td>
                    <td>
                        <div id="sta_ip">192.168.3.1&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>mDNS:</td>
                    <td>
                        <div id="mdns">&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>CAN Bitrate:</td>
                    <td>
                        <div id="can_bitrate_status">500K&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>CAN Mode:</td>
                    <td>
                        <div id="can_mode_status">Silent&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Port Type:</td>
                    <td>
                        <div id="port_type_status">TCP&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>TCP/UDP Port:</td>
                    <td>
                        <div id="port_status">3333&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Battery Voltage:</td>
                    <td>
                        <div id="batt_voltage">12.8V&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td><input id="check_status_button" name="check_status_button" type="button" onclick="checkStatus()"
                            value="Check status" /></td>
                    <td>&nbsp;</td>
                </tr>
            </table>
        </div>

        <div id="wifi_settings" class="tabcontent">
            <form id="configForm" name="configForm" action="/action_page" onchange="submit_enable();">
                <div class="section-title">AP Config</div>
                <table class="form-table">
                    <tr>
                        <td>Mode:</td>
                        <td>
                            <select name="wifi_mode" id="wifi_mode">
                                <option value="AP">AP</option>
                                <option value="APStation">AP+Station</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>AP Channel:</td>
                        <td>
                            <select name="ap_ch_value" id="ap_ch_value">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>AP Password:</td>
                        <td>
                            <input type="text" id="ap_pass_value" name="ap_pass_value" value="Testpass" />
                        </td>
                    </tr>
                </table>

                <div class="divider"></div>

                <div class="section-title">Station Config</div>
                <table class="form-table">
                    <tr>
                        <td>SSID:</td>
                        <td>
                            <input type="text" id="ssid_value" name="ssid_value" value="MeatPi" disabled />
                        </td>
                    </tr>
                    <tr>
                        <td>Password:</td>
                        <td>
                            <input type="text" id="pass_value" name="pass_value" value="TomatoSauce" disabled />
                        </td>
                    </tr>
                </table>

                <div class="divider"></div>

                <div class="section-title">CAN</div>
                <table class="form-table">
                    <tr>
                        <td>CAN Bitrate:</td>
                        <td>
                            <select name="can_datarate" id="can_datarate">
                                <option value="5K">5K</option>
                                <option value="10K">10K</option>
                                <option value="20K">20K</option>
                                <option value="25K">25K</option>
                                <option value="50K">50K</option>
                                <option value="100K">100K</option>
                                <option value="125K">125K</option>
                                <option value="250K">250K</option>
                                <option value="500K">500K</option>
                                <option value="800K">800K</option>
                                <option value="1000K">1000K</option>
                                <option value="auto">Auto</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>CAN Mode:</td>
                        <td>
                            <select name="can_mode" id="can_mode">
                                <option value="normal" selected="selected">Normal</option>
                                <option value="silent">Silent</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Port Type:</td>
                        <td>
                            <select name="port_type" id="port_type">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>TCP/UDP Port:</td>
                        <td>
                            <input type="number" id="tcp_port_value" name="tcp_port_value" value="3333" min="1" max="65535" />
                        </td>
                    </tr>
                    <tr>
                        <td>Protocol:</td>
                        <td>
                            <select name="protocol" id="protocol">
                                <option value="realdash66">realdash66</option>
                                <option value="slcan">slcan</option>
                                <option value="savvycan">savvyCAN</option>
                                <option value="elm327">elm327</option>
                                <option value="auto_pid">AutoPID</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>MQTT:</td>
                        <td>
                            <select name="mqtt_en" id="mqtt_en">
                                <option value="enable">Enable</option>
                                <option value="disable">Disable</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <div class="divider"></div>

                <div class="section-title">BLE</div>
                <table class="form-table">
                    <tr>
                        <td>Passkey:</td>
                        <td>
                            <input type="number" id="ble_pass_value" name="ble_pass_value" value="000000" min="0" max="999999" />
                        </td>
                    </tr>
                    <tr>
                        <td>BLE Status:</td>
                        <td>
                            <select name="ble_status" id="ble_status">
                                <option value="enable">Enable</option>
                                <option value="disable">Disable</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <div id="mqtt_en_div">
                    <div class="divider"></div>
                    <div class="section-title">MQTT</div>
                    <table class="form-table">
                        <tr>
                            <td><label for="mqtt_url"><b>MQTT URL:</b></label></td>
                            <td><input type="text" id="mqtt_url" name="mqtt_url" value="127.0.0.1" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_port"><b>MQTT Port:</b></label></td>
                            <td><input type="number" id="mqtt_port" name="mqtt_port" value="1883" min="1" max="65535" />
                            </td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_user"><b>MQTT User:</b></label></td>
                            <td><input type="text" id="mqtt_user" name="mqtt_user" value="meatpi" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_pass"><b>MQTT Pass:</b></label></td>
                            <td><input type="text" id="mqtt_pass" name="mqtt_pass" value="meatpi" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_tx_topic"><b>TX Topic:</b></label></td>
                            <td><input type="text" id="mqtt_tx_topic" name="mqtt_tx_topic" value="" /></td>
                            <td><input type="checkbox" id="mqtt_tx_en_checkbox" name="mqtt_tx_en_checkbox"
                                    onchange="txCheckBoxChanged()"></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_rx_topic"><b>RX Topic:</b></label></td>
                            <td><input type="text" id="mqtt_rx_topic" name="mqtt_rx_topic" value="" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_status_topic"><b>Status Topic:</b></label></td>
                            <td><input type="text" id="mqtt_status_topic" name="mqtt_status_topic" value="" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_elm327_log"><b>MQTT elm327 log:</b></label></td>
                            <td><select name="mqtt_elm327_log" style="width: 93px;" id="mqtt_elm327_log"
                                    onchange="alert_elm327()">
                                    <option value="enable">Enable</option>
                                    <option value="disable">Disable</option>
                                </select></td>
                        </tr>
                        <tr>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                    </table>
                    <div style="overflow-x:auto;">
                        <table id="can_flt_table">
                            <tr>
                                <th>CAN ID (dec)</th>
                                <th>Name</th>
                                <th>PID</th>
                                <th>Index</th>
                                <th>Start Bit</th>
                                <th>Bit Length</th>
                                <th>Expression</th>
                                <th>Cycle ms</th>
                                <th><input id="store_canflt_button" name="store_canflt_button" type="button"
                                        onclick="storeCANFLT()" value="Store" style="width: 70px;" /></th>
                            </tr>
                            <tr>
                                <td><input type="number" id="canId" min="0" max="536870912" style="width: 100px;" /></td>
                                <td><input type="text" id="name" maxlength="16" style="width: 70px;" /></td>
                                <td><input type="number" id="pid" style="width: 40px;" /></td>
                                <td><input type="number" id="pindex" style="width: 40px;" /></td>
                                <td><input type="number" id="startBit" min="0" max="63" style="width: 40px;" /></td>
                                <td><input type="number" id="bitLength" min="1" max="64" style="width: 40px;" /></td>
                                <td><input type="text" id="expression" maxlength="32" style="width: 100px;" /></td>
                                <td><input type="number" id="cycle" min="100" max="1000" style="width: 50px;" /></td>
                                <td><input id="add_row_button" name="add_row_button" type="button" onclick="addCANFLTRow()"
                                        value="Add ID" style="width: 70px;" /></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </form>
        </div>

        <div id="automate" class="tabcontent">
            <div class="section-title">Automate Settings</div>
            <table class="form-table">
                <tr>
                    <td>Vehicle Specific:</td>
                    <td>
                        <select id="car_specific" name="car_specific" onchange="toggleCarModel(); toggleDestinationAndCycle(); enableAutoStoreButton();submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Vehicle Model:</td>
                    <td style="display: flex; align-items: center; gap: 5px;">
                        <select id="car_model" name="car_model" onchange="enableAutoStoreButton();submit_enable();" style="flex: 1;"></select>
                        <div onclick="fetchVehicleProfiles()" style="cursor: pointer; display: flex; align-items: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0114.35-3.36L23 10"></path>
                                <path d="M20.49 15a9 9 0 01-14.35 3.36L1 14"></path>
                            </svg>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Home Assistant Discovery:</td>
                    <td>
                        <select id="ha_discovery" name="ha_discovery" onchange="checkForDuplicates(); toggleDestinationAndCycle(); toggleSendToFields(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Grouping:</td>
                    <td>
                        <select id="grouping" name="grouping" onchange="checkForDuplicates(); toggleDestinationAndCycle(); toggleSendToFields(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Destination Topic:</td>
                    <td>
                        <input type="text" id="destination" name="destination" disabled oninput="enableAutoStoreButton();submit_enable();">
                    </td>
                </tr>
                <tr>
                    <td>Cycle Time(ms):</td>
                    <td>
                        <input type="text" id="pid_cycle" name="pid_cycle" value="5000" disabled oninput="enableAutoStoreButton();submit_enable();">
                    </td>
                </tr>
                <tr>
                    <td>Vehicle Profiles:</td>
                    <td>
                        <form id="car_data_form" enctype="multipart/form-data">
                            <input id="car_data_file" name="car_data_file" type="file" onchange="sendCARDataFile();submit_enable();" />
                        </form>
                    </td>
                </tr>
            </table>
            <div class="section-title">Custom PIDs</div>
            <table class="form-table">
                <tr>
                    <td>Custom Initialisation:</td>
                    <td>
                        <input type="text" id="initialisation" name="initialisation" oninput="enableAutoStoreButton()">
                    </td>
                </tr>
            </table>
            
            <div id="automate_table">
                <div class="pid-entries"></div>
            </div>
            
            <div class="button-group">
                <button onclick="addRowAutoTable()" class="primary-button">New</button>
                <button id="custom_pid_store" onclick="storeAutoTableData()" class="store" disabled>Store</button>
            </div>
        </div>

        <div id="monitor" class="tabcontent">
            <div class="section-title">Monitor Settings</div>
            <table class="form-table">
                <tr>
                    <td>Bitrate</td>
                    <td>Filter</td>
                    <td>Mask</td>
                </tr>
                <tr>
                    <td>
                        <select name="mon_datarate" id="mon_datarate">
                            <option value="10K">10K</option>
                            <option value="20K">20K</option>
                            <option value="50K">50K</option>
                            <option value="100K">100K</option>
                            <option value="125K">125K</option>
                            <option value="250K">250K</option>
                            <option value="500K" selected="selected">500K</option>
                            <option value="800K">800K</option>
                            <option value="1000K">1Mbit</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" id="mon_filter" name="mon_filter" value="00000000" />
                    </td>
                    <td>
                        <input type="text" id="mon_mask" name="mon_mask" value="FFFFFFFF" />
                    </td>
                    <td><input id="mon_button" name="mon_button" type="button" onclick="mon_control()" value="Start"
                        style="font-size: 100%;" /></td>
                </tr>
            </table>
            <div class="divider"></div>
            <table id="table2" class="form-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Len</th>
                        <th>Data</th>
                        <th>Time</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="power_saving_tab" class="tabcontent">
            <div class="section-title">Sleep Mode</div>
            <table class="form-table">
                <tr>
                    <td>Sleep Mode:</td>
                    <td>
                        <select name="sleep_status" id="sleep_status">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Sleep Voltage:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="sleep_volt" 
                               name="sleep_volt" 
                               value="13.2" 
                               min="12.0" 
                               max="15.0" 
                               step="0.1"
                               oninput="document.getElementById('sleep_volt_value').textContent = this.value;submit_enable();">
                        <span id="sleep_volt_value">13.2</span>V
                    </td>
                </tr>
                <tr>
                    <td>Sleep After:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="sleep_time" 
                               name="sleep_time" 
                               value="2" 
                               min="1" 
                               max="30" 
                               step="1"
                               oninput="document.getElementById('sleep_time_value').textContent = this.value;submit_enable();">
                        <span id="sleep_time_value">2</span>min
                    </td>
                </tr>
                <tr>
                    <td>Wake-up Voltage:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="wakeup_volt" 
                               name="wakeup_volt" 
                               value="13.2" 
                               min="12.0" 
                               max="15.0" 
                               step="0.1"
                               oninput="document.getElementById('wakeup_volt_value').textContent = this.value;submit_enable();">
                        <span id="wakeup_volt_value">13.2</span>V
                    </td>
                </tr>
                <tr>
                    <td>Battery Alert:</td>
                    <td>
                        <select name="batt_alert" id="batt_alert" onchange="submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
            </table>
            <div id="batt_alert_div">
                <div class="divider"></div>
                <div class="section-title">Battery Alert</div>
                <table class="form-table">
                    <tr>
                        <td><label for="batt_alert_ssid"><b>SSID:</b></label></td>
                        <td><input type="text" id="batt_alert_ssid" name="batt_alert_ssid" value="MeatPi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_pass"><b>Password:</b></label></td>
                        <td><input type="text" id="batt_alert_pass" name="batt_alert_pass" value="TomatoSauce" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_volt"><b>Alert Voltage:</b></label></td>
                        <td><input type="number" step="0.1" id="batt_alert_volt" name="batt_alert_volt" value="11.0"
                                min="9.0" max="15.0" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_protocol"><b>Alert Protocol:</b></label></td>
                        <td><select name="batt_alert_protocol" style="width: 93px;" id="batt_alert_protocol">
                                <option value="mqtt">MQTT</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_url"><b>Alert URL:</b></label></td>
                        <td><input type="text" id="batt_alert_url" name="batt_alert_url" value="127.0.0.1" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_port"><b>Alert Port:</b></label></td>
                        <td><input type="number" id="batt_alert_port" name="batt_alert_port" value="1883" min="1"
                                max="65535" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_mqttusername"><b>Alert MQTT User:</b></label></td>
                        <td><input type="text" id="batt_mqtt_user" name="batt_mqtt_user" value="meatpi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_mqttpass"><b>Alert MQTT Pass:</b></label></td>
                        <td><input type="text" id="batt_mqtt_pass" name="batt_mqtt_pass" value="meatpi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_topic"><b>Alert Topic:</b></label></td>
                        <td><input type="text" id="batt_alert_topic" name="batt_alert_topic" value="CAR1/voltage" />
                        </td>
                    </tr>
                    <tr>
                        <td><b>Alert every:</b></td>
                        <td><select name="batt_alert_time" style="width: 93px;" id="batt_alert_time">
                                <option value="1">1hr</option>
                                <option value="6">6hr</option>
                                <option value="12">12hr</option>
                                <option value="24">1day</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                </table>
            </div>

        </div>

        <div id="about_tab" class="tabcontent">
            <div class="section-title">About</div>
            <form id="ota_form" action="/upload/ota.bin" method="post" enctype="multipart/form-data">
                <table class="form-table">
                    <tr>
                        <td>Firmware ver:</td>
                        <td>
                            <div id="fw_version">1.00</div>
                        </td>
                    </tr>
                    <tr>
                        <td>Hardware ver:</td>
                        <td>
                            <div id="hw_version">v2.10</div>
                        </td>
                    </tr>
                    <tr>
                        <td>Git ver:</td>
                        <td>
                            <div id="git_version">v2.10</div>
                        </td>
                    </tr>
                    <tr>
                        <td>Designed By:</td>
                        <td>
                            <div id="made_by"><a href="https://www.meatpi.com/"><b>meatpi.com</b></a></div>
                        </td>
                    </tr>
                    <tr>
                        <td><input id="ota_file" name="ota_file" type="file" /></td>
                        <td><input id="ota_submit_button" type="button" value="Update" onclick="otaClick()" /></td>
                    </tr>
                    <tr>
                        <td><input id="reboot_button" name="reboot_button" type="button" onclick="reboot()" value="Reboot" /></td>
                    </tr>
                </table>
            </form>
        </div>
        <input id="submit_button" name="submit_button" type="button" onclick="postConfig()" value="Submit Changes" disabled />
    </div>
    
    
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // loadAutoTable(initialData);
			// loadCarModels(carModelsData);
        });
		let latest_car_models = null;
        function loadCarModels(data) {
            const carModelSelect = document.getElementById("car_model");
            if (data && Array.isArray(data.supported)) {
				carModelSelect.innerHTML = "";
                data.supported.forEach(model => {
                    const option = document.createElement("option");
                    option.value = model;
                    option.text = model;
                    carModelSelect.appendChild(option);
                });
            } else {
                console.error("Invalid data format or missing 'supported' property.");
            }
			toggleCarModel();
			toggleDestinationAndCycle();
			toggleSendToFields();
        }

        function showNotification(message, color = "red", duration = 5000) {
            const notification = document.getElementById("notification");
            
            // Set the colors based on the parameter
            switch (color) {
                case "red":
                    notification.style.backgroundColor = "#fee2e2";
                    notification.style.borderColor = "#ef4444";
                    notification.style.color = "#991b1b";
                    break;
                case "green":
                    notification.style.backgroundColor = "#dcfce7";
                    notification.style.borderColor = "#22c55e";
                    notification.style.color = "#166534";
                    break;
                case "blue":
                    notification.style.backgroundColor = "#dbeafe";
                    notification.style.borderColor = "#3b82f6";
                    notification.style.color = "#1e40af";
                    break;
                case "yellow":
                    notification.style.backgroundColor = "#fef9c3";
                    notification.style.borderColor = "#eab308";
                    notification.style.color = "#854d0e";
                    break;
                default:
                    notification.style.backgroundColor = "#fee2e2";
                    notification.style.borderColor = "#ef4444";
                    notification.style.color = "#991b1b";
            }

            notification.innerHTML = message;
            notification.classList.add("show");
            
            // Clear any existing timeout
            if (window.notificationTimeout) {
                clearTimeout(window.notificationTimeout);
            }
            
            // Set new timeout
            window.notificationTimeout = setTimeout(() => {
                notification.classList.remove("show");
            }, duration);
        }
		async function fetchVehicleProfiles() {
			try {
				if (!navigator.onLine) {
					throw new Error('No internet connection');
				}
				const response = await fetch('https://raw.githubusercontent.com/meatpiHQ/wican-fw/main/vehicle_profiles.json');
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				const data = await response.json();
				console.log(data);
				latest_car_models = data;
				const carModels = [];
				if (data && Array.isArray(data.cars)) {
					data.cars.forEach(car => {
						if (car.car_model) {
							carModels.push(car.car_model);
						}
					});
				}
				console.log(carModels);
				var mod = { "supported": carModels };
				loadCarModels(mod);
				enableAutoStoreButton();
			} catch (error) {
				console.error('There was a problem with the fetch operation:', error);
                showNotification("Unable to fetch vehicle_profiles.json. " + error.message, "red");
			}
		}

        function toggleCarModel() {
            const carSpecific = document.getElementById("car_specific").value;
            const carModelSelect = document.getElementById("car_model");
            if (carSpecific === "disable") {
                carModelSelect.disabled = true;
                carModelSelect.value = "unspecified";
            } else {
                carModelSelect.disabled = false;
            }
			toggleDiscovery();
        }

        function toggleDestinationAndCycle() {
			const carSpecific = document.getElementById("car_specific").value;
			const grouping = document.getElementById("grouping").value;
			const destinationField = document.getElementById("destination");
			const cycleField = document.getElementById("pid_cycle");
			
			if (carSpecific === "enable" || grouping === "Group ALL") {
				destinationField.disabled = false;
				cycleField.disabled = false;
			} else {
				destinationField.disabled = true;
				cycleField.disabled = true;
			}
        }
		
		function toggleDiscovery() {
			const carSpecific = document.getElementById("car_specific").value;
			const discovery = document.getElementById("ha_discovery");

			discovery.disabled = true;
			discovery.value = "disable";
		}
		
        function txCheckBoxChanged() {
            if (document.getElementById("mqtt_tx_en_checkbox").checked) {
                document.getElementById("mqtt_tx_topic").disabled = false;
            } else {
                document.getElementById("mqtt_tx_topic").disabled = true;
            }
        }
		
		function sendCARDataFile() {
			const fileInput = document.getElementById("car_data_file");
			const maxFileSize = 200 * 1024; // 200KB in bytes

			if (fileInput.files.length == 0) {
                showNotification("No files selected!", "red");
				alert("No files selected!");
			} else {
				const file = fileInput.files[0];

				if (file.size > maxFileSize) {
                    showNotification("File size exceeds 200KB!", "red");
					alert("File size exceeds 200KB!");
					return;
				}

				const reader = new FileReader();
				reader.onload = function(event) {
					try {
						JSON.parse(event.target.result);
						// If parsing is successful, proceed with the upload
						const form = document.getElementById('car_data_form');
						const formData = new FormData(form);
						latest_car_models = null;
						fetch('/upload/car_data.json', {
							method: 'POST',
							body: formData
						})
						.then(response => response.text())
						.then(data => {
							console.log('Success:', data);
                            showNotification(data, "green");
							setTimeout(() => {
								window.location.reload();
							}, 1000);
						})
						.catch(error => {
							console.error('Error:', error);
						});
					} catch (e) {
                        showNotification("Invalid JSON file!", "red");
						alert("The selected file is not a valid JSON file!");
					}
				};

				// Read the file as text
				reader.readAsText(file);
			}
		}

        function addRowAutoTable() {
    addCollapsibleRow();
    enableAutoStoreButton();
}

function addCollapsibleRow(rowData = {}) {
    const container = document.querySelector('.pid-entries');
    const entry = document.createElement('div');
    entry.className = 'pid-entry';

    entry.innerHTML = `
        <div class="pid-header">
            <div class="header-left">
                <button type="button" class="collapse-btn">â–¼</button>
                <span class="pid-title">New PID</span>
            </div>
            <div class="header-right">
                <button type="button" class="delete-btn">Delete</button>
            </div>
        </div>
        <div class="pid-content hidden">
            <div class="pid-field">
                <label>Name</label>
                <input type="text" class="name-input" value="${rowData.Name || ''}" placeholder="Parameter Name">
            </div>
            <div class="pid-field">
                <label>Init</label>
                <input type="text" class="init-input" value="${rowData.Init || ''}" placeholder="PID Init">
            </div>
            <div class="pid-field">
                <label>PID</label>
                <input type="text" class="pid-input" value="${rowData.PID || ''}" placeholder="PID">
            </div>
            <div class="pid-field">
                <label>Expression</label>
                <input type="text" class="expression-input" value="${rowData.Expression || ''}" placeholder="Enter expression">
            </div>
            <div class="pid-field">
                <label>Period(ms)</label>
                <input type="number" class="period-input" value="${rowData.Period || ''}" placeholder="ms">
            </div>
            <div class="pid-field">
                <label>Type</label>
                <select class="type-select">
                    <option value="MQTT_Topic" ${rowData.Type === 'MQTT_Topic' ? 'selected' : ''}>MQTT_Topic</option>
                    <option value="MQTT_WallBox" ${rowData.Type === 'MQTT_WallBox' ? 'selected' : ''}>MQTT_WallBox</option>
                </select>
            </div>
            <div class="pid-field">
                <label>Send_to</label>
                <input type="text" class="send-to-input" value="${rowData.Send_to || ''}" placeholder="Enter destination">
            </div>
        </div>
    `;

    // Add these CSS styles
    const style = document.createElement('style');
    style.textContent = `
        .pid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            margin-top: 0.5rem;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
        }
        
        .header-right {
            display: flex;
            gap: 0.5rem;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem 0.5rem;
            color: var(--gray-700);
        }
        
        .pid-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: height 0.3s ease;
        }
        
        .pid-content.hidden {
            display: none;
        }
    `;
    document.head.appendChild(style);
    const header = entry.querySelector('.pid-header');
    const deleteBtn = entry.querySelector('.delete-btn');
    const collapseBtn = entry.querySelector('.collapse-btn');
    const content = entry.querySelector('.pid-content');
    const parameterTitle = entry.querySelector('.pid-title');
    const nameInput = entry.querySelector('.name-input');
    const pidInput = entry.querySelector('.pid-input');

    deleteBtn.addEventListener('click', () => {
        entry.remove();
        enableAutoStoreButton();
    });

    const toggleCollapse = (e) => {
        e.stopPropagation();
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        collapseBtn.textContent = isHidden ? 'â–²' : 'â–¼';
    };

    header.addEventListener('click', toggleCollapse);
    collapseBtn.addEventListener('click', toggleCollapse);

    parameterTitle.textContent = rowData.Name ? rowData.Name : 'New PID';
    const updateTitle = () => {
        parameterTitle.textContent = `${nameInput.value || 'New Parameter'}`;
    };

    nameInput.addEventListener('input', updateTitle);
    pidInput.addEventListener('input', updateTitle);

    entry.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', enableAutoStoreButton);
    });

    container.appendChild(entry);
}

// Update the loadAutoTable function to work with the new structure
function loadAutoTable(jsonData) {
        try {
            console.log("Raw jsonData:", jsonData);
            const data = JSON.parse(jsonData);
            console.log("Parsed data:", data);

            // First set the initialisation value
            const initialisationElement = document.getElementById("initialisation");
            if (initialisationElement) {
                initialisationElement.value = data.initialisation || '';
            }

            // Clear existing content
            const automateTable = document.getElementById("automate_table");
            if (!automateTable) {
                console.error("Automate table not found");
                return;
            }

            // Set form values safely
            const setElementValue = (id, value, defaultValue = '') => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || defaultValue;
                }
            };

            setElementValue("car_specific", data.car_specific, 'disable');
            setElementValue("ha_discovery", 'disable');
            setElementValue("grouping", data.grouping, 'disable');
            setElementValue("pid_cycle", data.cycle, '5000');
            setElementValue("destination", data.destination, '');
            setElementValue("car_model", data.car_model, '');

            // Load PIDs data
            if (data.pids && Array.isArray(data.pids)) {
                data.pids.forEach((pidData, index) => {
                    console.log(`Loading PID ${index}:`, pidData);
                    addCollapsibleRow({
                        Name: pidData.Name || '',
                        Init: pidData.Init || '',
                        PID: pidData.PID || '',
                        Expression: pidData.Expression || '',
                        Period: pidData.Period || '',
                        Type: pidData.Type || 'MQTT_Topic',
                        Send_to: pidData.Send_to || ''
                    });
                });
            }

            // Update UI states after elements are created
            requestAnimationFrame(() => {
                try {
                    const carSpecificElement = document.getElementById("car_specific");
                    if (carSpecificElement) {
                        carSpecificElement.dispatchEvent(new Event('change'));
                    }

                    const groupingElement = document.getElementById("grouping");
                    if (groupingElement) {
                        groupingElement.dispatchEvent(new Event('change'));
                    }

                    if (typeof toggleCarModel === 'function') toggleCarModel();
                    if (typeof toggleDestinationAndCycle === 'function') toggleDestinationAndCycle();
                    if (typeof toggleSendToFields === 'function') toggleSendToFields();
                } catch (error) {
                    console.error('Error in UI updates:', error);
                }
            });

            console.log("loadAutoTable completed successfully");

        } catch (error) {
            console.error('Error in loadAutoTable:', error);
            showNotification("Error loading table data: " + error.message, "red");
        }
    }


        function enableAutoStoreButton() {
            const storeButton = document.querySelector('button.store');
            if (storeButton) {
                storeButton.disabled = false;
            }
            document.getElementById("custom_pid_store").disabled = false;
        }
		
        async function storeAutoTableData() {
        try {
            // Get all PID entries
            const entries = document.querySelectorAll('.pid-entry');
            const data = [];

            // Get form values
            const initialisationValue = document.getElementById("initialisation").value;
            const groupingValue = document.getElementById("grouping").value;
            const ha_discoveryValue = document.getElementById("ha_discovery").value;
            const destinationValue = document.getElementById("destination").value;
            const cycleField = document.getElementById("pid_cycle");
            const cycleValue = cycleField.value;
            const carSpecificValue = document.getElementById("car_specific").value;
            const carModelField = document.getElementById("car_model");
            const carModelValue = carModelField.value;

            // Validate cycle time
            if (!cycleField.disabled && (!/^\d+$/.test(cycleValue) || parseInt(cycleValue) < 1000)) {
                showNotification("Cycle must be a number greater than 1000", "red");
                return false;
            }

            // Validate car model
            if (!carModelField.disabled && carModelValue.length === 0) {
                showNotification("Car Model must be selected", "red");
                return false;
            }

            // Process each PID entry
            entries.forEach(entry => {
                const pidData = {
                    Name: entry.querySelector('.name-input').value,
                    Init: entry.querySelector('.init-input').value,
                    PID: entry.querySelector('.pid-input').value,
                    Expression: entry.querySelector('.expression-input').value,
                    Period: entry.querySelector('.period-input').value,
                    Type: entry.querySelector('.type-select').value,
                    Send_to: entry.querySelector('.send-to-input').value
                };

                // Validate fields
                if (pidData.Name.length === 0 || pidData.Name.length >= 32) {
                    throw new Error("Name must not be empty and must be less than 32 characters");
                }
                if (pidData.PID.length === 0 || pidData.PID.length >= 10) {
                    throw new Error("PID must not be empty and must be less than 10 characters");
                }
                if (pidData.Expression.length === 0 || pidData.Expression.length >= 32) {
                    throw new Error("Expression must not be empty and must be less than 32 characters");
                }
                if (!/^\d+$/.test(pidData.Period) || (parseInt(pidData.Period) < 100 && parseInt(pidData.Period) != 0)) {
                    throw new Error("Period must be a number greater than 100");
                }
                if (pidData.Send_to.length >= 64) {
                    throw new Error("Send_to must be less than 64 characters");
                }

                data.push(pidData);
            });

            // Prepare data object for sending
            const jsonData = {
                initialisation: initialisationValue,
                grouping: groupingValue,
                destination: destinationValue,
                cycle: cycleValue,
                car_specific: carSpecificValue,
                ha_discovery: ha_discoveryValue,
                car_model: carModelValue,
                pids: data
            };

            // Send to server
            await fetch('store_auto_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.text())
            .then(result => {
                showNotification("Settings saved successfully", "green");
                document.querySelector(".store").disabled = true;
                document.getElementById("custom_pid_store").disabled = true;
            })
            .catch(error => {
                showNotification("Error saving settings: " + error.message, "red");
                return false;
            });

            return true;

        } catch (error) {
            showNotification(error.message, "red");
            return false;
        }
    }


    function checkForDuplicates() {
        const rows = document.querySelectorAll('.pid-entry');
        const pidMap = new Map();

        rows.forEach(row => {
            const pidInput = row.querySelector('.pid-input');
            const sendToInput = row.querySelector('.send-to-input');
            
            if (pidInput && pidInput.value) {
                const pidValue = pidInput.value;

                // Check if the PID already exists
                if (pidMap.has(pidValue)) {
                    pidMap.get(pidValue).push(sendToInput);
                } else {
                    pidMap.set(pidValue, [sendToInput]);
                }
            }
        });

        // Disable `sendToInput` for duplicate PIDs
        pidMap.forEach((inputs, pid) => {
            if (inputs.length > 1) {
                inputs.forEach(input => {
                    input.disabled = true;
                    input.value = '';
                });
            } else {
                inputs[0].disabled = false; // Enable input if it's not a duplicate
            }
        });
    }

        function toggleDestinationField() {
			const groupingValue = document.getElementById("grouping").value;
			toggleDestinationAndCycle();  // Reuse the updated function
        }

        function toggleSendToFields() {
            const groupingValue = document.getElementById("grouping")?.value || 'disable';
            const table = document.getElementById("automate_table");
            if (!table) return;

            const rows = table.getElementsByClassName('pid-entry');
            if (!rows.length) return;

            Array.from(rows).forEach(row => {
                const sendToInput = row.querySelector('.send-to-input');
                if (sendToInput) {
                    sendToInput.disabled = (groupingValue === "Group ALL");
                }
            });
        }

	var canData = [];

	function restoreCANFLTRow(id, n, p, pi, s, b, e, c) {
		var canId = id;
		if(canId < 0) {
			canId = 0;
		} else if(canId > 536870912) {
			canId = 536870912;
		}
		var name = n;
		var pid = p;
		var pindex = pi;
		var startBit = s;
		var bitLength = b;
		var expression = e;
		var cycle = c;
		var table = document.getElementById("can_flt_table");
		var row = table.insertRow(-1);
		var cell1 = row.insertCell(0);
		var cell2 = row.insertCell(1);
		var cell3 = row.insertCell(2);
		var cell4 = row.insertCell(3);
		var cell5 = row.insertCell(4);
		var cell6 = row.insertCell(5);
		var cell7 = row.insertCell(6);
		var cell8 = row.insertCell(7);
		var cell9 = row.insertCell(8);
		cell1.innerHTML = canId;
		cell2.innerHTML = name;
		cell3.innerHTML = pid;
		cell4.innerHTML = pindex;
		cell5.innerHTML = startBit;
		cell6.innerHTML = bitLength;
		cell7.innerHTML = expression;
		cell8.innerHTML = cycle;
		cell9.innerHTML = '<button style="width: 70px;" onclick="deleteCANFLTRow(this)">Delete</button>';
		canData.push({
			CANID: canId,
			Name: name,
			PID: pid,
			PIDIndex: pindex,
			StartBit: startBit,
			BitLength: bitLength,
			Expression: expression,
			Cycle: cycle
		});
		document.getElementById("canId").value = "";
		document.getElementById("name").value = "";
		document.getElementById("pid").value = "";
		document.getElementById("pindex").value = "";
		document.getElementById("startBit").value = "";
		document.getElementById("bitLength").value = "";
		document.getElementById("expression").value = "";
		document.getElementById("cycle").value = "";
	}

	function openTab(evt, tabName) {
		var i, tabcontent, tablinks;
		tabcontent = document.getElementsByClassName("tabcontent");
		for(i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		}
		tablinks = document.getElementsByClassName("tablinks");
		for(i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		}
		document.getElementById(tabName).style.display = "block";
		evt.currentTarget.className += " active";
	}

	function sta_enable() {}

	function submit_enable() {
        console.log("sumbit_enable");
		if(document.getElementById("wifi_mode").value == "AP") {
			document.getElementById("ssid_value").disabled = true;
			document.getElementById("pass_value").disabled = true;
			document.getElementById("ble_status").disabled = false;
		} else {
			document.getElementById("ssid_value").disabled = false;
			document.getElementById("pass_value").disabled = false;
			document.getElementById("ble_status").disabled = true;
			document.getElementById("ble_status").selectedIndex = "1";
		}
		if(document.getElementById("ble_status").selectedIndex == "0") {
			alert("Warrning!\\r\\n\\r\\nWhen BLE is connected the WiFi AP WiCAN_xxxxxx will be disabled.\\r\\nTo re-ennable the WiFi AP Turn OFF BLE on your phone or device, then power cycle WiCAN. If you connect to WiFi AP ssid WiCAN_xxxxxx, the BLE will automatically be disabled.");
			document.getElementById("mqtt_en").value = "disable";
			document.getElementById("mqtt_en_div").style.display = "none";
			document.getElementById("mqtt_en").disabled = true;
			document.getElementById("batt_alert").value = "disable";
			document.getElementById("batt_alert_div").style.display = "none";
			document.getElementById("batt_alert").disabled = true;
		} else {
			document.getElementById("mqtt_en").disabled = false;
			document.getElementById("batt_alert").disabled = false;
		}
		if(document.getElementById("ap_pass_value").value.length < 8 || document.getElementById("ap_pass_value").value.length > 63 || document.getElementById("pass_value").value.length < 8 || document.getElementById("pass_value").value.length > 63) {
            showNotification("AP/Station password len, min=0 max=64", "red");
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("ssid_value").value.length < 1 || document.getElementById("ssid_value").value.length > 32) {
            showNotification("AP/station ssid len, min=1 max=32", "red");
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("mqtt_tx_topic").value.length < 1 || document.getElementById("mqtt_tx_topic").value.length > 32) {
            showNotification("MQTT TX Topic length, min=1 max=64", "red");
			document.getElementById("submit_button").disabled = true;
		}  else if(document.getElementById("mqtt_rx_topic").value.length < 1 || document.getElementById("mqtt_rx_topic").value.length > 32) {
            showNotification("MQTT RX Topic length, min=1 max=64", "red");
			document.getElementById("submit_button").disabled = true;
		}  else if(document.getElementById("mqtt_status_topic").value.length < 1 || document.getElementById("mqtt_status_topic").value.length > 32) {
            showNotification("MQTT Status Topic length, min=1 max=64", "red");
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("tcp_port_value").value > 65535 || document.getElementById("tcp_port_value").value < 1) {
            showNotification("Port value, min=1 max=65535", "red");
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("batt_alert_port").value > 65535 || document.getElementById("batt_alert_port").value < 1) {
            showNotification("Port value, min=1 max=65535", "red");
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("ble_pass_value").value.length != 6 || document.getElementById("ble_pass_value").value.charAt(0) == "0") {
            showNotification("Passkey length, min=6 max=6, 1st number not 0", "red");
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("sleep_volt").value < 12 || document.getElementById("sleep_volt").value > 15) {
            showNotification("Sleep Voltage Value, min=12.0 max=15.0", "red");
			document.getElementById("submit_button").disabled = true;
		} 
        else if(document.getElementById("wakeup_volt").value < 12 || document.getElementById("wakeup_volt").value > 15) {
            showNotification("Wake-up Voltage Value, min=12.0 max=15.0", "red");
			document.getElementById("submit_button").disabled = true;
		}
        else if(parseFloat(document.getElementById("wakeup_volt").value) < parseFloat(document.getElementById("sleep_volt").value) + 0.2) {
            showNotification("Wake-up Voltage cannot be lower than Sleep Voltage + 0.2V", "red");
            document.getElementById("submit_button").disabled = true;
        }
        else {
			document.getElementById("submit_button").disabled = false;
		}
		if(document.getElementById("protocol").value == "savvycan") {
			document.getElementById("tcp_port_value").value = "23";
			document.getElementById("tcp_port_value").disabled = true;
			document.getElementById("port_type").selectedIndex = "0";
			document.getElementById("port_type").disabled = true;
		} else {
			document.getElementById("tcp_port_value").disabled = false;
			document.getElementById("port_type").selectedIndex = "0";
			document.getElementById("port_type").disabled = false;
		}
		if(document.getElementById("sleep_status").value == "enable") {
			if(document.getElementById("ble_status").selectedIndex != "0") {
				document.getElementById("batt_alert").disabled = false;
			}
		} else if(document.getElementById("sleep_status").value == "disable") {
			document.getElementById("batt_alert").disabled = true;
			document.getElementById("batt_alert").selectedIndex = "1";
		}
		if(document.getElementById("batt_alert").value == "enable") {
			document.getElementById("batt_alert_div").style.display = "block";
		} else if(document.getElementById("batt_alert").value == "disable") {
			document.getElementById("batt_alert_div").style.display = "none";
		}
		if(document.getElementById("mqtt_en").value == "enable") {
			document.getElementById("mqtt_en_div").style.display = "block";
		} else if(document.getElementById("mqtt_en").value == "disable") {
			document.getElementById("mqtt_en_div").style.display = "none";
		}
		if(document.getElementById("protocol").value == "elm327") {
			document.getElementById("mqtt_elm327_log").disabled = false;
		} else {
			document.getElementById("mqtt_elm327_log").disabled = true;
            document.getElementById("mqtt_elm327_log").value = "disable";
		}
	}
	document.getElementById("defaultOpen").click();

	function checkStatus() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(obj.wifi_mode == "APStation") {
				document.getElementById("wifi_mode_current").innerHTML = "AP+Station";
			} else if(obj.wifi_mode == "AP") {
				document.getElementById("wifi_mode_current").innerHTML = "AP";
			}
			document.getElementById("sta_status").innerHTML = obj.sta_status;
			document.getElementById("ap_channel_status").innerHTML = obj.ap_ch;
			document.getElementById("sta_ip").innerHTML = obj.sta_ip;
            document.getElementById("mdns").innerHTML = obj.mdns;
			document.getElementById("can_bitrate_status").innerHTML = obj.can_datarate;
			if(obj.can_mode == "normal") {
				document.getElementById("can_mode_status").innerHTML = "Normal";
			} else if(obj.can_mode == "silent") {
				document.getElementById("can_mode_status").innerHTML = "Silent";
			}
			if(obj.port_type == "tcp") {
				document.getElementById("port_type_status").innerHTML = "TCP";
			} else if(obj.port_type == "udp") {
				document.getElementById("port_type_status").innerHTML = "UDP";
			}
			document.getElementById("port_status").innerHTML = obj.port;
			document.getElementById("fw_version").innerHTML = obj.fw_version;
			document.getElementById("hw_version").innerHTML = obj.hw_version;
			document.getElementById("git_version").innerHTML = obj.git_version;
			document.getElementById("protocol").value = obj.protocol;
			document.getElementById("batt_voltage").innerHTML = obj.batt_voltage;
			if(document.getElementById("batt_alert").value == "enable") {
				document.getElementById("batt_alert_div").style.display = "block";
			} else if(document.getElementById("batt_alert").value == "disable") {
				document.getElementById("batt_alert_div").style.display = "none";
			}
			if(document.getElementById("mqtt_en").value == "enable") {
				document.getElementById("mqtt_en_div").style.display = "block";
			} else if(document.getElementById("mqtt_en").value == "disable") {
				document.getElementById("mqtt_en_div").style.display = "none";
			}
		};
		xhttp.open("GET", "/check_status");
		xhttp.send();
	}

	function loadCANFLT() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(this.responseText != "NONE") {
				if(Array.isArray(obj.can_flt)) {
					obj.can_flt.forEach((item) => {
						restoreCANFLTRow(item["CANID"], item["Name"], item["PID"], item["PIDIndex"], item["StartBit"], item["BitLength"], item["Expression"], item["Cycle"]);
					});
				}
			}
		};
		xhttp.open("GET", "/load_canflt");
		xhttp.send();
	}

	function loadautoPIDConfig() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			console.log("Car models:", this.responseText);
			if(this.responseText != "NONE") {
				var obj = JSON.parse(this.responseText);
				loadCarModels(obj);
				loadautoPID();
			}else{
				toggleCarModel();
				toggleDestinationAndCycle();
				toggleSendToFields();
			}
		};
		xhttp.open("GET", "/load_auto_pid_config");
		xhttp.send();
	}

    function loadautoPID() {
        console.log("Loading auto PID data..."); // Debug log
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            console.log("Server response:", this.responseText); // Debug log
            if(this.responseText !== "NONE") {
                loadAutoTable(this.responseText);
                document.getElementById("custom_pid_store").disabled = true;
            } else {
                console.log("No PID data found on server");
            }
        };
        xhttp.onerror = function(error) {
            console.error("Error loading auto PID:", error);
        };
        xhttp.open("GET", "/load_auto_pid");
        xhttp.send();
    }

	function postCANFLT() {
		var obj = {};
		obj["can_flt"] = canData;
		var canfltJSON = JSON.stringify(obj);
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            showNotification(this.responseText, "green");
			submit_enable();
		};
		xhttp.open("POST", "/store_canflt");
		xhttp.send(canfltJSON);
	}

	async function postConfig() {
		var obj = {};
        const storeResult = await storeAutoTableData();
        if (!storeResult) {
            return;
        }
		obj["wifi_mode"] = document.getElementById("wifi_mode").value;
		obj["ap_ch"] = document.getElementById("ap_ch_value").value;
		obj["sta_ssid"] = document.getElementById("ssid_value").value;
		obj["sta_pass"] = document.getElementById("pass_value").value;
		obj["can_datarate"] = document.getElementById("can_datarate").value;
		obj["can_mode"] = document.getElementById("can_mode").value;
		obj["port_type"] = document.getElementById("port_type").value;
		obj["port"] = document.getElementById("tcp_port_value").value;
		obj["ap_pass"] = document.getElementById("ap_pass_value").value;
		obj["protocol"] = document.getElementById("protocol").value;
		obj["ble_pass"] = document.getElementById("ble_pass_value").value;
		obj["ble_status"] = document.getElementById("ble_status").value;
		obj["sleep_status"] = document.getElementById("sleep_status").value;
		obj["sleep_volt"] = document.getElementById("sleep_volt").value;
        obj["wakeup_volt"] = document.getElementById("wakeup_volt").value;
		obj["batt_alert"] = document.getElementById("batt_alert").value;
		obj["batt_alert_ssid"] = document.getElementById("batt_alert_ssid").value;
		obj["batt_alert_pass"] = document.getElementById("batt_alert_pass").value;
		obj["batt_alert_volt"] = document.getElementById("batt_alert_volt").value;
		obj["batt_alert_protocol"] = document.getElementById("batt_alert_protocol").value;
		let mqtt_txt = "mqtt://";
		let mqtt_url_val = mqtt_txt.concat(document.getElementById("batt_alert_url").value);
		obj["batt_alert_url"] = mqtt_url_val;
		obj["batt_alert_port"] = document.getElementById("batt_alert_port").value;
		obj["batt_alert_topic"] = document.getElementById("batt_alert_topic").value;
		obj["batt_alert_time"] = document.getElementById("batt_alert_time").value;
		obj["batt_mqtt_user"] = document.getElementById("batt_mqtt_user").value;
		obj["batt_mqtt_pass"] = document.getElementById("batt_mqtt_pass").value;
		obj["mqtt_en"] = document.getElementById("mqtt_en").value;
		let mqtt_txt2 = "mqtt://";
		let mqtt_url_val2 = mqtt_txt.concat(document.getElementById("mqtt_url").value);
		obj["mqtt_url"] = mqtt_url_val2;
		obj["mqtt_port"] = document.getElementById("mqtt_port").value;
		obj["mqtt_user"] = document.getElementById("mqtt_user").value;
		obj["mqtt_pass"] = document.getElementById("mqtt_pass").value;
		obj["mqtt_tx_topic"] = document.getElementById("mqtt_tx_topic").value;
		if(document.getElementById("mqtt_tx_en_checkbox").checked){
			obj["mqtt_tx_en"] = "enable";
		}else{
			obj["mqtt_tx_en"] = "disable";
		}
		obj["mqtt_rx_topic"] = document.getElementById("mqtt_rx_topic").value;
		obj["mqtt_status_topic"] = document.getElementById("mqtt_status_topic").value;
		obj["mqtt_elm327_log"] = document.getElementById("mqtt_elm327_log").value;
		var configJSON = JSON.stringify(obj);
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            showNotification(this.responseText, "green");
            document.getElementById("submit_button").disabled = true;
		};
        xhttp.onerror = function() {
            showNotification("Failed to save configuration", "red");
        };

		xhttp.open("POST", "/store_config");
		xhttp.send(configJSON);
	}

	function otaClick() {
		if(document.getElementById("ota_file").files.length == 0) {
            showNotification("No files selected!", "red");
			alert("No files selected!");
		} else {
			document.getElementById("ota_submit_button").disabled = true;
            showNotification("Updating please wait...", "green");
			setTimeout(function() {
				document.getElementById("ota_form").submit();
			}, 5000);
		}
	}

	function reboot() {
		const xhttp = new XMLHttpRequest();
		document.getElementById("reboot_button").disabled = true;
        showNotification("Rebooting please reconnect...", "yellow");
		xhttp.open("POST", "/system_reboot");
		xhttp.send("reboot");
	}

	function Load() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(obj.wifi_mode == "APStation") {
				document.getElementById("wifi_mode").selectedIndex = "1";
				document.getElementById("ssid_value").disabled = false;
				document.getElementById("pass_value").disabled = false;
			} else if(obj.wifi_mode == "AP") {
				document.getElementById("wifi_mode").selectedIndex = "0";
				document.getElementById("ssid_value").disabled = true;
				document.getElementById("pass_value").disabled = true;
			}
			var ch = parseInt(obj.ap_ch);
			ch = ch - 1;
			document.getElementById("ap_ch_value").selectedIndex = ch.toString();
			document.getElementById("ssid_value").value = obj.sta_ssid;
			document.getElementById("pass_value").value = obj.sta_pass;
			if(obj.can_datarate == "5K") {
				document.getElementById("can_datarate").selectedIndex = "0";
			} else if(obj.can_datarate == "10K") {
				document.getElementById("can_datarate").selectedIndex = "1";
			} else if(obj.can_datarate == "20K") {
				document.getElementById("can_datarate").selectedIndex = "2";
			} else if(obj.can_datarate == "25K") {
				document.getElementById("can_datarate").selectedIndex = "3";
			} else if(obj.can_datarate == "50K") {
				document.getElementById("can_datarate").selectedIndex = "4";
			} else if(obj.can_datarate == "100K") {
				document.getElementById("can_datarate").selectedIndex = "5";
			} else if(obj.can_datarate == "125K") {
				document.getElementById("can_datarate").selectedIndex = "6";
			} else if(obj.can_datarate == "250K") {
				document.getElementById("can_datarate").selectedIndex = "7";
			} else if(obj.can_datarate == "500K") {
				document.getElementById("can_datarate").selectedIndex = "8";
			} else if(obj.can_datarate == "800K") {
				document.getElementById("can_datarate").selectedIndex = "9";
			} else if(obj.can_datarate == "1000K") {
				document.getElementById("can_datarate").selectedIndex = "10";
			} else if(obj.can_datarate == "auto") {
				document.getElementById("can_datarate").selectedIndex = "11";
			}
			if(obj.can_mode == "normal") {
				document.getElementById("can_mode").selectedIndex = "0";
			} else if(obj.can_mode == "silent") {
				document.getElementById("can_mode").selectedIndex = "1";
			}
			if(obj.port_type == "tcp") {
				document.getElementById("port_type").selectedIndex = "0";
			} else if(obj.port_type == "udp") {
				document.getElementById("port_type").selectedIndex = "1";
			}
			if(obj.ble_status == "enable") {
				document.getElementById("ble_status").selectedIndex = "0";
			} else if(obj.ble_status == "disable") {
				document.getElementById("ble_status").selectedIndex = "1";
			}
			if(obj.sleep_status == "enable") {
				document.getElementById("sleep_status").selectedIndex = "0";
			} else if(obj.sleep_status == "disable") {
				document.getElementById("sleep_status").selectedIndex = "1";
			}

			if ("mqtt_tx_en" in obj) {
				if (obj.mqtt_tx_en === "enable") {
					document.getElementById("mqtt_tx_en_checkbox").checked = true;
				} else {
					document.getElementById("mqtt_tx_en_checkbox").checked = false;
				}
			} else {
				document.getElementById("mqtt_tx_en_checkbox").checked = false; 
			}
			
			txCheckBoxChanged();
			document.getElementById("protocol").value = obj.protocol;
			document.getElementById("tcp_port_value").value = obj.port;
			document.getElementById("ap_pass_value").value = obj.ap_pass;
			document.getElementById("ble_pass_value").value = obj.ble_pass;
			document.getElementById("sleep_volt").value = obj.sleep_volt;
            document.getElementById("sleep_volt_value").textContent = obj.sleep_volt;
            document.getElementById("wakeup_volt").value = obj.wakeup_volt;
            document.getElementById('wakeup_volt_value').textContent = obj.wakeup_volt;
			document.getElementById("batt_alert").value = obj.batt_alert;
			document.getElementById("batt_alert_ssid").value = obj.batt_alert_ssid;
			document.getElementById("batt_alert_pass").value = obj.batt_alert_pass;
			document.getElementById("batt_alert_volt").value = obj.batt_alert_volt;
			document.getElementById("batt_alert_protocol").value = obj.batt_alert_protocol;
			document.getElementById("batt_alert_url").value = obj.batt_alert_url.slice(7);
			document.getElementById("batt_alert_port").value = obj.batt_alert_port;
			document.getElementById("batt_alert_topic").value = obj.batt_alert_topic;
			document.getElementById("batt_mqtt_user").value = obj.batt_mqtt_user;
			document.getElementById("batt_mqtt_pass").value = obj.batt_mqtt_pass;
			document.getElementById("mqtt_en").value = obj.mqtt_en;
			document.getElementById("mqtt_url").value = obj.mqtt_url.slice(7);
			document.getElementById("mqtt_port").value = obj.mqtt_port;
			document.getElementById("mqtt_user").value = obj.mqtt_user;
			document.getElementById("mqtt_pass").value = obj.mqtt_pass;
			document.getElementById("mqtt_tx_topic").value = obj.mqtt_tx_topic;
			document.getElementById("mqtt_rx_topic").value = obj.mqtt_rx_topic;
			document.getElementById("mqtt_status_topic").value = obj.mqtt_status_topic;
			document.getElementById("mqtt_elm327_log").value = obj.mqtt_elm327_log;
			if(obj.batt_alert_time == "1") {
				document.getElementById("batt_alert_time").selectedIndex = "0";
			} else if(obj.batt_alert_time == "6") {
				document.getElementById("batt_alert_time").selectedIndex = "1";
			} else if(obj.batt_alert_time == "12") {
				document.getElementById("batt_alert_time").selectedIndex = "2";
			} else if(obj.batt_alert_time == "24") {
				document.getElementById("batt_alert_time").selectedIndex = "3";
			}
			if(document.getElementById("protocol").value == "savvycan") {
				document.getElementById("tcp_port_value").value = "23";
				document.getElementById("tcp_port_value").disabled = true;
				document.getElementById("port_type").selectedIndex = "0";
				document.getElementById("port_type").disabled = true;
			}
			if(document.getElementById("batt_alert").value == "enable") {
				document.getElementById("batt_alert_div").style.display = "block";
			} else if(document.getElementById("batt_alert").value == "disable") {
				document.getElementById("batt_alert_div").style.display = "none";
			}
			if(document.getElementById("mqtt_en").value == "enable") {
				document.getElementById("mqtt_en_div").style.display = "block";
			} else if(document.getElementById("mqtt_en").value == "disable") {
				document.getElementById("mqtt_en_div").style.display = "none";
			}
			loadCANFLT();
			loadautoPIDConfig();
			document.getElementById("store_canflt_button").disabled = true;
			document.querySelector(".store").disabled = true;
            document.getElementById("submit_button").disabled = true;
		};
		checkStatus();
		xhttp.open("GET", "/load_config");
		xhttp.send();
	}

	function monitor_add_line(id, type, len, data, time) {
		var table = document.getElementById("table2");
		var nraw = -1;
		if(typeof monitor_add_line.msg_time == "undefined") {
			monitor_add_line.msg_time = [0];
		}
		for(var r = 1, n = table.rows.length; r < n; r++) {
			if(table.rows[r].cells[0].innerHTML == id) {
				nraw = r;
				break;
			}
		}
		if(nraw != -1) {
			table.rows[nraw].cells[0].innerHTML = id;
			table.rows[nraw].cells[1].innerHTML = type;
			table.rows[nraw].cells[2].innerHTML = len;
			table.rows[nraw].cells[3].innerHTML = data;
			table.rows[nraw].cells[4].innerHTML = Date.now() - monitor_add_line.msg_time[nraw];
			table.rows[nraw].cells[5].innerHTML = ++table.rows[nraw].cells[5].innerHTML;
			monitor_add_line.msg_time[nraw] = Date.now();
		} else {
			var row = table.insertRow(1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			cell1.innerHTML = id;
			cell2.innerHTML = type;
			cell3.innerHTML = len;
			cell4.innerHTML = data;
			cell5.innerHTML = 0;
			cell6.innerHTML = 1;
            cell1.style.width = "10%"
			monitor_add_line.msg_time.push(Date.now());
		}
	}
	var ws = null;
	var cr = String.fromCharCode(13);

	function mon_control() {
		var dr = document.getElementById("mon_datarate").selectedIndex;
		var url = window.location.href;
		var url2 = "http://192.168.31.72/";
		console.log(dr);
		alert("Please reboot device after Monitor, otherwise the device may not function as expected");
		ws_url = "ws://" + url.substr(7, url.length) + "ws";
		console.log(ws_url);
		if(document.getElementById("mon_button").value == "Start") {
			ws = new WebSocket(ws_url);
			setTimeout(bindEvents, 1000);
			ws.addEventListener("open", (event) => {
				var cmd = "C" + cr + "S" + dr + cr + "O" + cr;
				console.log("onopen called");
				ws.send(cmd);
				window.mon_button_en(0);
			});
			ws.addEventListener("close", (event) => {
				window.mon_button_en(1);
				console.log("onclose called");
			});
		} else {
			ws_close();
		}
	}

	function bindEvents() {
		ws.onmessage = function(evt) {
			var received_msg = evt.data;
			if(received_msg[0] == "t") {
				var len = (received_msg[4] - "0") * 2;
				var data_str = "";
				var i;
				for(i = 0; i < len; i += 2) {
					data_str += received_msg.substr(i + 5, 2) + " ";
				}
				monitor_add_line(received_msg.substr(1, 3) + "h", "Std", received_msg[4], data_str, 0);
			} else if(received_msg[0] == "T") {
				var len = (received_msg[9] - "0") * 2;
				var data_str = "";
				var i;
				for(i = 0; i < len; i += 2) {
					data_str += received_msg.substr(i + 10, 2) + " ";
				}
				monitor_add_line(received_msg.substr(1, 8) + "h", "Ext", received_msg[9], data_str, 0);
			} else if(received_msg[0] == "r") {
				var len = (received_msg[4] - "0") * 2;
				monitor_add_line(received_msg.substr(1, 3) + "h", "RTR-Std", received_msg[4], 0, 0);
			} else if(received_msg[0] == "R") {
				var len = (received_msg[9] - "0") * 2;
				monitor_add_line(received_msg.substr(1, 8) + "h", "RTR-Ext", received_msg[9], 0, 0);
			}
		};
	}

	function ws_close() {
		ws.send("C" + cr);
		ws.close();
	}

	function mon_button_en(b) {
		if(b == 1) {
			document.getElementById("mon_button").value = "Start";
			document.getElementById("mon_datarate").disabled = false;
			document.getElementById("mon_filter").disabled = false;
			document.getElementById("mon_mask").disabled = false;
		} else {
			document.getElementById("mon_button").value = "Stop";
			document.getElementById("mon_datarate").disabled = true;
			document.getElementById("mon_filter").disabled = true;
			document.getElementById("mon_mask").disabled = true;
		}
	}

	function isNameUnique(name) {
		return canData.every((item) => item["Name"] !== name);
	}

	function addCANFLTRow() {
		var canId = parseInt(document.getElementById("canId").value);
		var startBit = parseInt(document.getElementById("startBit").value);
		var bitLength = parseInt(document.getElementById("bitLength").value);
		Length = parseInt(document.getElementById("bitLength").value);
		var cycle = parseInt(document.getElementById("cycle").value);
		var name = document.getElementById("name").value;
		var expression = document.getElementById("expression").value;
		var pid = parseInt(document.getElementById("pid").value);
		var pidi = parseInt(document.getElementById("pindex").value);
		if(isNaN(canId) || canId == "" || canId < 0 || canId > 536870912) {
			alert("CAN ID must be a valid number between 0 and 536870912");
			return;
		}
		if(isNaN(startBit) || isNaN(bitLength) || startBit > 64 - bitLength || bitLength <= 0 || bitLength > 64 || startBit < 0 || startBit > 63) {
			alert("startBit or bitLength error");
			return;
		}
		if(isNaN(cycle) || cycle < 100 || cycle > 10000) {
			alert("cycle must be between 100 and 10000");
			return;
		}
		if(name.length < 1 || name.length > 16) {
			alert("Name must be between 1 and 16 characters in length.");
			return;
		}
		if(expression.length < 1 || expression.length > 32) {
			alert("Expression must be between 1 and 32 characters in length.");
			return;
		}
		if(isNaN(pid) || pid < -1 || pid > 255) {
			alert("PID must be a number between -1 and 255");
			return;
		}
		if(isNaN(pidi) || pidi < 0 || pidi > 7) {
			alert("PID must be a number between 0 and 7");
			return;
		}
		if(isNameUnique(name)) {
			var table = document.getElementById("can_flt_table");
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			var cell7 = row.insertCell(6);
			var cell8 = row.insertCell(7);
			var cell9 = row.insertCell(8);
			if(table.rows.length - 1 >= 100) {
				alert("Maximum row limit (100) reached.");
				return;
			}
			cell1.innerHTML = canId;
			cell2.innerHTML = name;
			cell3.innerHTML = pid;
			cell4.innerHTML = pidi;
			cell5.innerHTML = startBit;
			cell6.innerHTML = bitLength;
			cell7.innerHTML = expression;
			cell8.innerHTML = cycle;
			cell9.innerHTML = '<button style="width: 70px;" onclick="deleteCANFLTRow(this) ">Delete</button>';
			canData.push({
				CANID: canId,
				Name: name,
				PID: pid,
				PIDIndex: pidi,
				StartBit: startBit,
				BitLength: bitLength,
				Expression: expression,
				Cycle: cycle
			});
			document.getElementById("canId").value = "";
			document.getElementById("name").value = "";
			document.getElementById("pid").value = "";
			document.getElementById("pindex").value = "";
			document.getElementById("startBit").value = "";
			document.getElementById("bitLength").value = "";
			document.getElementById("expression").value = "";
			document.getElementById("cycle").value = "";
		} else {
			alert("Name must be unique.");
		}
		document.getElementById("store_canflt_button").disabled = false;
	}

	function deleteCANFLTRow(button) {
		var row = button.parentNode.parentNode;
		var canIdToDelete = row.cells[0].textContent;
		var indexToDelete = canData.findIndex((item) => item["CANID"] === parseInt(canIdToDelete));
		if(indexToDelete !== -1) {
			canData.splice(indexToDelete, 1);
		}
		row.parentNode.removeChild(row);
		document.getElementById("store_canflt_button").disabled = false;
	}

	function alert_elm327() {
		alert("If elm327 log is enabled then only CAN frames proccessed by elm327 will be sent to MQTT broker.");
	}

	function storeCANFLT() {
		postCANFLT();
		document.getElementById("store_canflt_button").disabled = true;
	}
    </script>
</body>

</html>
